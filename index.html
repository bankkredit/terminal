<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANKING SYSTEM - Gesti√≥n Crediticia</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #1e40af;
            --dark-blue: #1e3a5f;
            --light-blue: #3b82f6;
            --gray-bg: #f1f5f9;
            --gray-border: #cbd5e1;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --white: #ffffff;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --info: #0891b2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--gray-bg);
            color: var(--text-primary);
            font-size: 13px;
            line-height: 1.4;
        }

        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.active {
            display: flex;
            flex-direction: column;
        }

        .institutional-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: var(--white);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--secondary-blue);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .bank-logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .bank-subtitle {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 400;
        }

        .header-info {
            text-align: right;
            font-size: 12px;
        }

        .header-user {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-datetime {
            opacity: 0.8;
            font-size: 11px;
        }

        .main-nav {
            background-color: var(--white);
            border-bottom: 2px solid var(--gray-border);
            padding: 0 24px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 14px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .nav-item:hover {
            color: var(--primary-blue);
            background-color: var(--gray-bg);
        }

        .nav-item.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            background-color: var(--gray-bg);
        }

        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .module-container {
            display: none;
            background: var(--white);
            border: 1px solid var(--gray-border);
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .module-container.active {
            display: block;
        }

        .module-header {
            background: linear-gradient(to right, var(--gray-bg), var(--white));
            padding: 16px 20px;
            border-bottom: 2px solid var(--gray-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .module-actions {
            display: flex;
            gap: 8px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
        }

        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 420px;
            border-top: 5px solid var(--secondary-blue);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-title {
            font-size: 24px;
            color: var(--primary-blue);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--gray-border);
            border-radius: 3px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
            background: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--light-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid transparent;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .btn-primary:hover {
            background: var(--dark-blue);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--text-primary);
            border-color: var(--gray-border);
        }

        .btn-secondary:hover {
            background: var(--gray-bg);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
            border-color: var(--success);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
            border-color: var(--danger);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
            border-color: var(--warning);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
            border-color: var(--info);
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 11px;
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .hidden { display: none !important; }
        
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .alert-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }

        .alert-warning {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .form-section {
            background: var(--gray-bg);
            border: 1px solid var(--gray-border);
            border-radius: 4px;
            padding: 16px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary-blue);
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-border);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .data-table-container {
            overflow-x: auto;
            margin: 20px;
            border: 1px solid var(--gray-border);
            border-radius: 4px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table thead {
            background: var(--primary-blue);
            color: var(--white);
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray-border);
        }

        .data-table tbody tr:hover {
            background: var(--gray-bg);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 4px;
            width: 95%;
            max-width: 900px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: 20px;
        }

        .modal-header {
            background: var(--primary-blue);
            color: var(--white);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            background: var(--gray-bg);
            border-top: 1px solid var(--gray-border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            position: sticky;
            bottom: 0;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-border);
            background: var(--gray-bg);
            padding: 0 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            background: var(--white);
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            border: 1px solid var(--gray-border);
            border-radius: 4px;
            padding: 20px;
            border-left: 4px solid var(--primary-blue);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-success {
            background: #d1fae5;
            color: var(--success);
        }

        .badge-warning {
            background: #fef3c7;
            color: var(--warning);
        }

        .badge-danger {
            background: #fee2e2;
            color: var(--danger);
        }

        .badge-info {
            background: #dbeafe;
            color: var(--light-blue);
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-border);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border-left: 4px solid var(--success);
            padding: 16px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .filter-bar {
            background: var(--gray-bg);
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-border);
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .accounting-entry {
            background: #f8fafc;
            border: 1px solid var(--gray-border);
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--gray-border);
            font-weight: 700;
            color: var(--primary-blue);
        }

        .entry-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 16px;
            padding: 4px 0;
        }

        .entry-debit {
            text-align: right;
            color: var(--danger);
        }

        .entry-credit {
            text-align: right;
            color: var(--success);
        }

        .log-entry {
            border-left: 3px solid var(--gray-border);
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--gray-bg);
            font-size: 12px;
            position: relative;
        }

        .log-entry.create { border-left-color: var(--success); }
        .log-entry.update { border-left-color: var(--warning); }
        .log-entry.delete { border-left-color: var(--danger); }
        .log-entry.auth { border-left-color: var(--light-blue); }
        .log-entry.payment { border-left-color: var(--info); }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .log-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .amortization-table {
            font-size: 11px;
        }

        .amortization-table th,
        .amortization-table td {
            padding: 6px;
            text-align: right;
        }

        .amortization-table td:first-child,
        .amortization-table th:first-child {
            text-align: center;
        }

        .report-container {
            background: white;
            padding: 40px;
            border: 1px solid var(--gray-border);
            font-size: 12px;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 20px;
        }

        .report-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-blue);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .report-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .report-section {
            margin-bottom: 24px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .report-table th,
        .report-table td {
            border: 1px solid var(--gray-border);
            padding: 8px;
            text-align: left;
        }

        .report-table th {
            background: var(--gray-bg);
            font-weight: 600;
        }

        .text-muted {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .detail-view {
            background: #f8fafc;
            border: 1px solid var(--gray-border);
            border-radius: 4px;
            padding: 20px;
            margin-top: 16px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .edit-warning {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .cuenta-nivel-1 { font-weight: bold; background: #e0e7ff; }
        .cuenta-nivel-2 { font-weight: bold; background: #eef2ff; }
        .cuenta-nivel-3 { padding-left: 20px; }
        .cuenta-nivel-4 { padding-left: 40px; font-size: 11px; }
        .cuenta-nivel-5 { padding-left: 60px; font-size: 11px; color: var(--text-secondary); }

        @media (max-width: 768px) {
            .main-nav { flex-wrap: wrap; }
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .filter-bar { flex-direction: column; }
            .modal-content { width: 100%; margin: 0; border-radius: 0; }
            .detail-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-title">CORE BANKING SYSTEM</div>
                <div class="login-subtitle">Sistema de Gesti√≥n Crediticia Institucional v3.0</div>
            </div>
            
            <div id="loginError" class="alert alert-error hidden"></div>
            
            <form id="loginForm" onsubmit="authModule.login(event)">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">Correo Electr√≥nico</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="admin@banco.com" required autocomplete="email">
                </div>
                <div class="form-group" style="margin-bottom: 24px;">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%; padding: 14px; justify-content: center;">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <div class="text-center" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--gray-border);">
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                    ¬øPrimera vez? Cree una cuenta de administrador
                </p>
                <button onclick="authModule.showRegister()" class="btn btn-secondary" style="width: 100%;">
                    Registrarse como Administrador
                </button>
            </div>
        </div>
    </div>

    <!-- REGISTER SCREEN -->
    <div id="registerScreen" class="login-container hidden">
        <div class="login-box">
            <div class="login-header">
                <div class="login-title">REGISTRO ADMINISTRADOR</div>
                <div class="login-subtitle">Crear nueva cuenta institucional</div>
            </div>
            
            <div id="registerError" class="alert alert-error hidden"></div>
            <div id="registerSuccess" class="alert alert-success hidden"></div>
            
            <form id="registerForm" onsubmit="authModule.register(event)">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">Nombre Completo *</label>
                    <input type="text" id="regName" class="form-control" required autocomplete="name">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">Correo Electr√≥nico *</label>
                    <input type="email" id="regEmail" class="form-control" required autocomplete="email">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">Contrase√±a (m√≠n. 6 caracteres) *</label>
                    <input type="password" id="regPassword" class="form-control" required minlength="6" autocomplete="new-password">
                </div>
                <div class="form-group" style="margin-bottom: 24px;">
                    <label class="form-label">Confirmar Contrase√±a *</label>
                    <input type="password" id="regConfirmPassword" class="form-control" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn btn-success" id="registerBtn" style="width: 100%; padding: 14px; justify-content: center;">
                    Crear Cuenta
                </button>
            </form>

            <div class="text-center" style="margin-top: 20px;">
                <button onclick="authModule.showLogin()" class="btn btn-secondary" style="width: 100%;">
                    ‚Üê Volver al Login
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="appContainer" class="app-container">
        <header class="institutional-header">
            <div class="header-brand">
                <div>
                    <div class="bank-logo">CORE BANKING</div>
                    <div class="bank-subtitle">Sistema Integral de Gesti√≥n Crediticia</div>
                </div>
            </div>
            <div class="header-info">
                <div class="header-user" id="currentUserName">Administrador</div>
                <div class="header-datetime" id="currentDateTime">2024-01-01 00:00:00</div>
                <button onclick="authModule.logout()" class="btn btn-sm btn-secondary" style="margin-top: 8px;">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </header>

        <nav class="main-nav">
            <button class="nav-item active" onclick="navModule.show('dashboard')">Dashboard</button>
            <button class="nav-item" onclick="navModule.show('clients')">Clientes</button>
            <button class="nav-item" onclick="navModule.show('credits')">Cr√©ditos</button>
            <button class="nav-item" onclick="navModule.show('payments')">Pagos</button>
            <button class="nav-item" onclick="navModule.show('accounting')">Contabilidad</button>
            <button class="nav-item" onclick="navModule.show('reports')">Reportes</button>
            <button class="nav-item" onclick="navModule.show('config')">Configuraci√≥n</button>
            <button class="nav-item" onclick="navModule.show('audit')">Bit√°cora</button>
        </nav>

        <main class="main-content">
            
            <!-- DASHBOARD MODULE -->
            <div id="module-dashboard" class="module-container active">
                <div class="module-header">
                    <div class="module-title">Panel de Control Institucional</div>
                    <div class="module-actions">
                        <button class="btn btn-secondary btn-sm" onclick="dashboardModule.refresh()">Actualizar</button>
                    </div>
                </div>
                
                <div style="padding: 24px;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Cartera Activa Total</div>
                            <div class="stat-value" id="statTotalPortfolio">$0.00</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--warning);">
                            <div class="stat-label">Intereses por Cobrar</div>
                            <div class="stat-value" id="statTotalInterest">$0.00</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--danger);">
                            <div class="stat-label">Cartera en Mora</div>
                            <div class="stat-value" id="statPastDue">$0.00</div>
                            <div style="font-size: 11px; color: var(--danger);" id="statPastDueCount">0 cr√©ditos</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--success);">
                            <div class="stat-label">Clientes Activos</div>
                            <div class="stat-value" id="statActiveClients">0</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--info);">
                            <div class="stat-label">Total Recaudado Hoy</div>
                            <div class="stat-value" id="statTodayPayments">$0.00</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="module-container" style="display: block;">
                            <div class="module-header">
                                <div class="module-title">Cr√©ditos Recientes</div>
                            </div>
                            <div class="data-table-container" style="margin: 0; border: none;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Cliente</th>
                                            <th>Monto</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentCreditsTable">
                                        <tr><td colspan="4" class="text-center">Cargando...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="module-container" style="display: block;">
                            <div class="module-header">
                                <div class="module-title">√öltimos Pagos</div>
                            </div>
                            <div class="data-table-container" style="margin: 0; border: none;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Cliente</th>
                                            <th>Monto</th>
                                            <th>Tipo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentPaymentsTable">
                                        <tr><td colspan="4" class="text-center">Cargando...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CLIENTS MODULE -->
            <div id="module-clients" class="module-container">
                <div class="module-header">
                    <div class="module-title">Administraci√≥n de Clientes</div>
                    <div class="module-actions">
                        <button class="btn btn-primary btn-sm" onclick="clientModule.showCreateModal()">+ Nuevo Cliente</button>
                        <button class="btn btn-secondary btn-sm" onclick="clientModule.exportToExcel()">Exportar Excel</button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Buscar</label>
                        <input type="text" id="clientSearch" class="form-control" placeholder="Nombre, c√©dula, tel√©fono..." onkeyup="clientModule.search()">
                    </div>
                    <div class="filter-group" style="flex: 0 0 auto;">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary" onclick="clientModule.clearFilters()">Limpiar</button>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Documento</th>
                                <th>Nombre Completo</th>
                                <th>Contacto</th>
                                <th>Capacidad Endeudamiento</th>
                                <th>Cr√©ditos Activos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTable">
                            <tr><td colspan="7" class="text-center">Cargando clientes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CREDITS MODULE -->
            <div id="module-credits" class="module-container">
                <div class="module-header">
                    <div class="module-title">Motor de Cr√©ditos</div>
                    <div class="module-actions">
                        <button class="btn btn-primary btn-sm" onclick="creditModule.showCreateModal()">+ Nuevo Cr√©dito</button>
                        <button class="btn btn-secondary btn-sm" onclick="creditModule.exportToExcel()">Exportar Excel</button>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="creditModule.switchTab('active', this)">Activos</button>
                    <button class="tab" onclick="creditModule.switchTab('paid', this)">Cancelados</button>
                    <button class="tab" onclick="creditModule.switchTab('default', this)">En Mora</button>
                    <button class="tab" onclick="creditModule.switchTab('all', this)">Todos</button>
                </div>

                <div class="filter-bar" style="border-top: 1px solid var(--gray-border);">
                    <div class="filter-group">
                        <label>Buscar Cliente</label>
                        <input type="text" id="creditSearch" class="form-control" placeholder="Nombre del cliente..." onkeyup="creditModule.search()">
                    </div>
                    <div class="filter-group">
                        <label>Desde</label>
                        <input type="date" id="creditDateFrom" class="form-control" onchange="creditModule.filter()">
                    </div>
                    <div class="filter-group">
                        <label>Hasta</label>
                        <input type="date" id="creditDateTo" class="form-control" onchange="creditModule.filter()">
                    </div>
                </div>

                <div class="data-table-container" style="margin: 0; border-top: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Cliente</th>
                                <th>Monto Original</th>
                                <th>Saldo Actual</th>
                                <th>Cuota</th>
                                <th>Pr√≥ximo Pago</th>
                                <th>D√≠as Mora</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="creditsTable">
                            <tr><td colspan="9" class="text-center">Cargando cr√©ditos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PAYMENTS MODULE -->
            <div id="module-payments" class="module-container">
                <div class="module-header">
                    <div class="module-title">Gesti√≥n de Pagos</div>
                    <div class="module-actions">
                        <button class="btn btn-primary btn-sm" onclick="paymentModule.showModal()">+ Registrar Pago</button>
                        <button class="btn btn-secondary btn-sm" onclick="paymentModule.exportToExcel()">Exportar Excel</button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label>No. Cr√©dito</label>
                        <input type="text" id="paymentSearchCredit" class="form-control" placeholder="Buscar por cr√©dito..." onkeyup="paymentModule.search()">
                    </div>
                    <div class="filter-group">
                        <label>Desde</label>
                        <input type="date" id="paymentDateFrom" class="form-control" onchange="paymentModule.filter()">
                    </div>
                    <div class="filter-group">
                        <label>Hasta</label>
                        <input type="date" id="paymentDateTo" class="form-control" onchange="paymentModule.filter()">
                    </div>
                    <div class="filter-group" style="flex: 0 0 auto;">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary" onclick="paymentModule.clearFilters()">Limpiar</button>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID Pago</th>
                                <th>Fecha/Hora</th>
                                <th>Cr√©dito</th>
                                <th>Cliente</th>
                                <th>Tipo Pago</th>
                                <th>Capital</th>
                                <th>Inter√©s</th>
                                <th>Total</th>
                                <th>Usuario</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <tr><td colspan="10" class="text-center">Cargando pagos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ACCOUNTING MODULE -->
            <div id="module-accounting" class="module-container">
                <div class="module-header">
                    <div class="module-title">Motor Contable Integrado</div>
                    <div class="module-actions">
                        <button class="btn btn-secondary btn-sm" onclick="accountingModule.refresh()">Actualizar</button>
                        <button class="btn btn-secondary btn-sm" onclick="accountingModule.exportToExcel()">Exportar Excel</button>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="accountingModule.switchTab('diario', this)">Libro Diario</button>
                    <button class="tab" onclick="accountingModule.switchTab('mayor', this)">Libro Mayor</button>
                    <button class="tab" onclick="accountingModule.switchTab('balance', this)">Balance General</button>
                    <button class="tab" onclick="accountingModule.switchTab('resultados', this)">Estado de Resultados</button>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Desde</label>
                        <input type="date" id="accountingDateFrom" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label>Hasta</label>
                        <input type="date" id="accountingDateTo" class="form-control">
                    </div>
                    <div class="filter-group" style="flex: 0 0 auto;">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="accountingModule.loadCurrentTab()">Generar</button>
                    </div>
                </div>

                <div id="accounting-diario" class="tab-content active">
                    <div id="diarioContainer" style="padding: 20px;"></div>
                </div>

                <div id="accounting-mayor" class="tab-content">
                    <div style="padding: 20px;">
                        <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                            <label class="form-label">Seleccionar Cuenta</label>
                            <select id="mayorAccountSelect" class="form-control" onchange="accountingModule.loadMayor()">
                                <option value="">Todas las cuentas</option>
                            </select>
                        </div>
                        <div id="mayorContainer"></div>
                    </div>
                </div>

                <div id="accounting-balance" class="tab-content">
                    <div id="balanceContainer" style="padding: 20px;"></div>
                </div>

                <div id="accounting-resultados" class="tab-content">
                    <div id="resultadosContainer" style="padding: 20px;"></div>
                </div>
            </div>

            <!-- REPORTS MODULE -->
            <div id="module-reports" class="module-container">
                <div class="module-header">
                    <div class="module-title">Reporter√≠a Financiera Avanzada</div>
                </div>

                <div style="padding: 24px;">
                    <div class="form-grid" style="padding: 0; margin-bottom: 24px;">
                        <div class="form-section">
                            <div class="section-title">Configuraci√≥n del Reporte</div>
                            <div class="form-group">
                                <label class="form-label">Tipo de Reporte *</label>
                                <select id="reportType" class="form-control" onchange="reportModule.updateForm()">
                                    <option value="">Seleccione...</option>
                                    <option value="cartera">Cartera Activa Detallada</option>
                                    <option value="cartera_vencida">Cartera Vencida</option>
                                    <option value="ingresos">Ingresos por Intereses</option>
                                    <option value="flujo_caja">Flujo de Caja</option>
                                    <option value="estado_cuenta">Estado de Cuenta por Cliente</option>
                                    <option value="morosidad">An√°lisis de Morosidad</option>
                                </select>
                            </div>
                            
                            <div id="reportFilters" style="display: none;">
                                <div class="form-row" id="reportDateRange">
                                    <div class="form-group">
                                        <label class="form-label">Desde</label>
                                        <input type="date" id="reportDateFrom" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Hasta</label>
                                        <input type="date" id="reportDateTo" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="form-group" id="reportClientFilter" style="display: none;">
                                    <label class="form-label">Cliente</label>
                                    <select id="reportClientSelect" class="form-control">
                                        <option value="">Seleccione cliente...</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-primary" onclick="reportModule.generate()" style="width: 100%; margin-top: 12px;">
                                Generar Reporte
                            </button>
                        </div>

                        <div class="form-section" id="reportPreviewSection" style="display: none;">
                            <div class="section-title">Vista Previa</div>
                            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                <button class="btn btn-secondary btn-sm" onclick="reportModule.exportPDF()">
                                    <span>üìÑ</span> PDF
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="reportModule.exportExcel()">
                                    <span>üìä</span> Excel
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="reportModule.print()">
                                    <span>üñ®Ô∏è</span> Imprimir
                                </button>
                            </div>
                            <div id="reportSummary" style="font-size: 12px;"></div>
                        </div>
                    </div>

                    <div id="reportContainer" style="display: none;">
                        <div class="report-container" id="reportContent"></div>
                    </div>
                </div>
            </div>

            <!-- CONFIG MODULE -->
            <div id="module-config" class="module-container">
                <div class="module-header">
                    <div class="module-title">Configuraci√≥n del Sistema Financiero</div>
                    <div class="module-actions">
                        <button class="btn btn-success btn-sm" onclick="configModule.save()">Guardar Cambios</button>
                    </div>
                </div>

                <div style="padding: 24px;">
                    <div class="form-grid">
                        <div class="form-section">
                            <div class="section-title">Par√°metros de Inter√©s</div>
                            <div class="form-group">
                                <label class="form-label">Tasa de Inter√©s Anual (%)</label>
                                <input type="number" id="configTasaAnual" class="form-control" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo de Inter√©s</label>
                                <select id="configTipoInteres" class="form-control">
                                    <option value="simple">Simple</option>
                                    <option value="compuesto">Compuesto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Capitalizaci√≥n</label>
                                <select id="configCapitalizacion" class="form-control">
                                    <option value="mensual">Mensual</option>
                                    <option value="diaria">Diaria</option>
                                    <option value="anual">Anual</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">Sistema de Amortizaci√≥n</div>
                            <div class="form-group">
                                <label class="form-label">M√©todo Predeterminado</label>
                                <select id="configMetodo" class="form-control">
                                    <option value="frances">Franc√©s (Cuotas iguales)</option>
                                    <option value="aleman">Alem√°n (Amortizaci√≥n constante)</option>
                                    <option value="americano">Americano (Cuota inter√©s + Capital final)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Comisi√≥n por Apertura (%)</label>
                                <input type="number" id="configComision" class="form-control" step="0.01">
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">Gesti√≥n de Mora</div>
                            <div class="form-group">
                                <label class="form-label">D√≠as de Gracia</label>
                                <input type="number" id="configDiasGracia" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tasa de Mora Diaria (%)</label>
                                <input type="number" id="configTasaMora" class="form-control" step="0.001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Penalizaci√≥n (%)</label>
                                <input type="number" id="configPenalizacion" class="form-control" step="0.01">
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">L√≠mites y Plazos</div>
                            <div class="form-group">
                                <label class="form-label">Monto M√°ximo ($)</label>
                                <input type="number" id="configMontoMax" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Plazo M√≠nimo (meses)</label>
                                <input type="number" id="configPlazoMin" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Plazo M√°ximo (meses)</label>
                                <input type="number" id="configPlazoMax" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="form-section" style="margin-top: 20px;">
                        <div class="section-title">Plan de Cuentas Contable (NIIF - Cat√°logo Ecuador)</div>
                        <div style="margin-bottom: 12px; font-size: 12px; color: var(--text-secondary);">
                            Plan de cuentas completo basado en NIIF y normativa de la Superintendencia de Bancos del Ecuador
                        </div>
                        <div class="data-table-container" style="margin: 0; max-height: 500px; overflow-y: auto;">
                            <table class="data-table" id="planCuentasTable">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descripci√≥n</th>
                                        <th>Tipo</th>
                                        <th>Naturaleza</th>
                                        <th class="text-right">Saldo Actual</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="planCuentasBody">
                                    <!-- Se carga din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUDIT MODULE -->
            <div id="module-audit" class="module-container">
                <div class="module-header">
                    <div class="module-title">Bit√°cora y Auditor√≠a del Sistema</div>
                    <div class="module-actions">
                        <button class="btn btn-secondary btn-sm" onclick="auditModule.refresh()">Actualizar</button>
                        <button class="btn btn-secondary btn-sm" onclick="auditModule.exportToExcel()">Exportar Excel</button>
                        <button class="btn btn-danger btn-sm" onclick="auditModule.confirmDeleteOld()">Archivar Antiguos</button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Tipo de Evento</label>
                        <select id="auditTypeFilter" class="form-control" onchange="auditModule.filter()">
                            <option value="">Todos</option>
                            <option value="create">Creaci√≥n</option>
                            <option value="update">Modificaci√≥n</option>
                            <option value="delete">Eliminaci√≥n</option>
                            <option value="auth">Autenticaci√≥n</option>
                            <option value="payment">Pagos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Entidad</label>
                        <select id="auditEntityFilter" class="form-control" onchange="auditModule.filter()">
                            <option value="">Todas</option>
                            <option value="cliente">Clientes</option>
                            <option value="credito">Cr√©ditos</option>
                            <option value="pago">Pagos</option>
                            <option value="configuracion">Configuraci√≥n</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Desde</label>
                        <input type="date" id="auditDateFrom" class="form-control" onchange="auditModule.filter()">
                    </div>
                    <div class="filter-group">
                        <label>Hasta</label>
                        <input type="date" id="auditDateTo" class="form-control" onchange="auditModule.filter()">
                    </div>
                    <div class="filter-group">
                        <label>Usuario</label>
                        <input type="text" id="auditUserFilter" class="form-control" placeholder="Filtrar por usuario..." onkeyup="auditModule.filter()">
                    </div>
                    <div class="filter-group" style="flex: 0 0 auto;">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary" onclick="auditModule.clearFilters()">Limpiar</button>
                    </div>
                </div>

                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            Mostrando <span id="auditCount">0</span> registros
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                                <input type="checkbox" id="auditAutoRefresh" checked> Auto-refresh
                            </label>
                        </div>
                    </div>
                    <div id="auditContainer" style="max-height: 600px; overflow-y: auto;">
                        <div class="text-center">Cargando registros...</div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: CLIENTE -->
    <div id="modalClient" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="clientModalTitle">Nuevo Cliente</div>
                <button class="modal-close" onclick="clientModule.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm" onsubmit="clientModule.save(event)">
                    <input type="hidden" id="clientId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo Documento *</label>
                            <select id="clientTipoDoc" class="form-control" required>
                                <option value="CEDULA">C√©dula</option>
                                <option value="RUC">RUC</option>
                                <option value="PASAPORTE">Pasaporte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero Documento *</label>
                            <input type="text" id="clientNumDoc" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombres *</label>
                            <input type="text" id="clientNombres" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apellidos *</label>
                            <input type="text" id="clientApellidos" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha Nacimiento</label>
                            <input type="date" id="clientFechaNac" class="form-control" onchange="clientModule.calcularEdad()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Edad</label>
                            <input type="text" id="clientEdad" class="form-control" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tel√©fono Principal *</label>
                            <input type="tel" id="clientTelefono" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tel√©fono Secundario</label>
                            <input type="tel" id="clientTelefono2" class="form-control">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" id="clientEmail" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Direcci√≥n Completa *</label>
                        <textarea id="clientDireccion" class="form-control" rows="2" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Provincia</label>
                            <select id="clientProvincia" class="form-control" onchange="clientModule.loadCantones()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cant√≥n</label>
                            <select id="clientCanton" class="form-control">
                                <option value="">Seleccione provincia...</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-title" style="margin-top: 20px;">Informaci√≥n Financiera</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Profesi√≥n/Ocupaci√≥n</label>
                            <input type="text" id="clientProfesion" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Empresa</label>
                            <input type="text" id="clientEmpresa" class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ingresos Mensuales ($) *</label>
                            <input type="number" id="clientIngresos" class="form-control" required onchange="clientModule.calcularCapacidad()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Otros Ingresos ($)</label>
                            <input type="number" id="clientOtrosIngresos" class="form-control" value="0" onchange="clientModule.calcularCapacidad()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gastos Mensuales ($) *</label>
                            <input type="number" id="clientGastos" class="form-control" required onchange="clientModule.calcularCapacidad()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Capacidad de Endeudamiento (40% disponible)</label>
                        <input type="text" id="clientCapacidad" class="form-control" readonly style="font-weight: bold; color: var(--primary-blue); font-size: 14px;">
                    </div>

                    <div class="section-title" style="margin-top: 20px;">Informaci√≥n Bancaria</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Banco</label>
                            <select id="clientBanco" class="form-control">
                                <option value="">Seleccione...</option>
                                <option value="PICHINCHA">Banco Pichincha</option>
                                <option value="GUAYAQUIL">Banco Guayaquil</option>
                                <option value="PACIFICO">Banco del Pac√≠fico</option>
                                <option value="AUSTRO">Banco del Austro</option>
                                <option value="PRODUBANCO">Produbanco</option>
                                <option value="INTERNACIONAL">Banco Internacional</option>
                                <option value="SOLIDARIO">Banco Solidario</option>
                                <option value="BOLIVARIANO">Banco Bolivariano</option>
                                <option value="LOJA">Banco de Loja</option>
                                <option value="MACHALA">Banco de Machala</option>
                                <option value="JEP">Cooperativa JEP</option>
                                <option value="MUSHUC_RUNA">Cooperativa Mushuc Runa</option>
                                <option value="OTRO">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo Cuenta</label>
                            <select id="clientTipoCuenta" class="form-control">
                                <option value="AHORROS">Ahorros</option>
                                <option value="CORRIENTE">Corriente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">No. Cuenta</label>
                            <input type="text" id="clientNumCuenta" class="form-control">
                        </div>
                    </div>

                    <div class="modal-footer" style="margin-top: 24px; padding: 16px 0 0 0;">
                        <button type="button" class="btn btn-secondary" onclick="clientModule.closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CR√âDITO -->
    <div id="modalCredit" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <div class="modal-title" id="creditModalTitle">Nuevo Cr√©dito</div>
                <button class="modal-close" onclick="creditModule.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="creditForm" onsubmit="creditModule.save(event)">
                    <input type="hidden" id="creditId">
                    <input type="hidden" id="creditEditMode" value="false">
                    
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button type="button" class="tab active" onclick="creditModule.switchCreditTab('data', this)">Datos Generales</button>
                        <button type="button" class="tab" onclick="creditModule.switchCreditTab('simulation', this)">Simulaci√≥n</button>
                    </div>

                    <div id="creditTabData" class="tab-content active">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Cliente *</label>
                                <select id="creditClientId" class="form-control" required onchange="creditModule.loadClientInfo()">
                                    <option value="">Seleccione cliente...</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Capacidad Endeudamiento</label>
                                <input type="text" id="creditClientCapacidad" class="form-control" readonly style="font-weight: bold; color: var(--primary-blue);">
                            </div>
                        </div>

                        <div id="creditClientInfo" style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 4px; padding: 12px; margin-bottom: 20px; display: none; font-size: 12px;">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Monto Solicitado ($) *</label>
                                <input type="number" id="creditMonto" class="form-control" required min="1" step="0.01" onchange="creditModule.calculateSimulation()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Plazo (meses) *</label>
                                <input type="number" id="creditPlazo" class="form-control" required min="1" max="360" onchange="creditModule.calculateSimulation()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tasa Anual (%) *</label>
                                <input type="number" id="creditTasa" class="form-control" required step="0.01" min="0" onchange="creditModule.calculateSimulation()">
                                <small style="font-size: 10px; color: var(--text-secondary);">Use 0 para cr√©ditos sin inter√©s</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Sistema Amortizaci√≥n *</label>
                                <select id="creditSistema" class="form-control" required onchange="creditModule.calculateSimulation()">
                                    <option value="frances">Franc√©s (Cuotas iguales)</option>
                                    <option value="aleman">Alem√°n (Amortizaci√≥n constante)</option>
                                    <option value="americano">Americano (Solo inter√©s + Capital final)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha Desembolso *</label>
                                <input type="date" id="creditFechaDesembolso" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">D√≠a de Pago (cada mes)</label>
                                <select id="creditDiaPago" class="form-control">
                                    <!-- Se llena din√°micamente con JavaScript -->
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Destino del Cr√©dito</label>
                                <select id="creditDestino" class="form-control">
                                    <option value="CONSUMO">Consumo</option>
                                    <option value="VIVIENDA">Vivienda</option>
                                    <option value="VEHICULO">Veh√≠culo</option>
                                    <option value="EDUCACION">Educaci√≥n</option>
                                    <option value="INVERSION">Inversi√≥n</option>
                                    <option value="LIQUIDEZ">Liquidez</option>
                                    <option value="OTRO">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Comisi√≥n Apertura ($)</label>
                                <input type="number" id="creditComision" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Seguro Desgravamen (%)</label>
                                <input type="number" id="creditSeguro" class="form-control" value="0" step="0.01" onchange="creditModule.calculateSimulation()">
                            </div>
                        </div>
                    </div>

                    <div id="creditTabSimulation" class="tab-content">
                        <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 4px; padding: 16px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Valor Cuota</div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="simCuota">$0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Total Intereses</div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--primary-blue);" id="simTotalInteres">$0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Total a Pagar</div>
                                    <div style="font-size: 20px; font-weight: 700;" id="simTotalPagar">$0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">TCEA</div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--warning);" id="simTCEA">0.00%</div>
                                </div>
                            </div>
                        </div>

                        <div class="data-table-container" style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table amortization-table">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Fecha Pago</th>
                                        <th>Cuota</th>
                                        <th>Capital</th>
                                        <th>Inter√©s</th>
                                        <th>Seguro</th>
                                        <th>Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="simulationTableBody">
                                    <tr><td colspan="7" class="text-center">Ingrese datos para simular</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="creditModule.closeModal()">Cancelar</button>
                        <button type="button" class="btn btn-info" onclick="creditModule.calculateSimulation()">Recalcular</button>
                        <button type="submit" class="btn btn-primary" id="creditSubmitBtn">Desembolsar Cr√©dito</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: DETALLE CR√âDITO -->
    <div id="modalCreditDetail" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Detalle del Cr√©dito</div>
                <button class="modal-close" onclick="creditModule.closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="creditDetailContent">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="creditModule.closeDetailModal()">Cerrar</button>
                <button class="btn btn-primary" onclick="creditModule.printDetail()">Imprimir</button>
            </div>
        </div>
    </div>

    <!-- MODAL: DETALLE CLIENTE (NUEVO) -->
    <div id="modalClientDetail" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Detalle Completo del Cliente</div>
                <button class="modal-close" onclick="clientModule.closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="clientDetailContent">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="clientModule.closeDetailModal()">Cerrar</button>
                <button class="btn btn-primary" onclick="clientModule.printDetail()">Imprimir</button>
            </div>
        </div>
    </div>

    <!-- MODAL: PAGO -->
    <div id="modalPayment" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Registrar Pago</div>
                <button class="modal-close" onclick="paymentModule.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="paymentForm" onsubmit="paymentModule.process(event)">
                    <div class="form-group">
                        <label class="form-label">Cr√©dito *</label>
                        <select id="paymentCreditId" class="form-control" required onchange="paymentModule.loadCreditDetails()">
                            <option value="">Seleccione cr√©dito...</option>
                        </select>
                    </div>

                    <div id="paymentCreditInfo" style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 4px; padding: 16px; margin-bottom: 20px; display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
                            <div><strong>Cliente:</strong> <span id="payInfoCliente"></span></div>
                            <div><strong>Saldo Actual:</strong> <span id="payInfoSaldo"></span></div>
                            <div><strong>Cuota Mensual:</strong> <span id="payInfoCuota"></span></div>
                            <div><strong>Pr√≥ximo Pago:</strong> <span id="payInfoProximo"></span></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Pago *</label>
                            <select id="paymentTipo" class="form-control" required onchange="paymentModule.updateAmount()">
                                <option value="CUOTA">Pago Cuota Regular</option>
                                <option value="CAPITAL">Abono a Capital</option>
                                <option value="INTERES">Pago de Intereses</option>
                                <option value="TOTAL">Cancelaci√≥n Total</option>
                                <option value="MORA">Pago de Mora</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto ($) *</label>
                            <input type="number" id="paymentMonto" class="form-control" required step="0.01">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Pago *</label>
                            <input type="date" id="paymentFecha" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√©todo de Pago</label>
                            <select id="paymentMetodo" class="form-control">
                                <option value="EFECTIVO">Efectivo</option>
                                <option value="TRANSFERENCIA">Transferencia</option>
                                <option value="CHEQUE">Cheque</option>
                                <option value="DEPOSITO">Dep√≥sito</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Referencia/Comprobante</label>
                        <input type="text" id="paymentReferencia" class="form-control" placeholder="No. comprobante, cheque, etc.">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea id="paymentObservaciones" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="modal-footer" style="padding: 16px 0 0 0;">
                        <button type="button" class="btn btn-secondary" onclick="paymentModule.closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Procesar Pago</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: EDITAR PAGO -->
    <div id="modalEditPayment" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Editar Pago</div>
                <button class="modal-close" onclick="paymentModule.closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editPaymentForm" onsubmit="paymentModule.saveEdit(event)">
                    <input type="hidden" id="editPaymentId">
                    
                    <div class="form-group">
                        <label class="form-label">Monto ($)</label>
                        <input type="number" id="editPaymentMonto" class="form-control" required step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="editPaymentFecha" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea id="editPaymentObs" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="modal-footer" style="padding: 16px 0 0 0;">
                        <button type="button" class="btn btn-secondary" onclick="paymentModule.closeEditModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIRMAR ARCHIVAR AUDITOR√çA -->
    <div id="modalArchiveAudit" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: var(--warning);">
                <div class="modal-title">Archivar Registros Antiguos</div>
                <button class="modal-close" onclick="auditModule.closeArchiveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    Esta acci√≥n mover√° los registros antiguos a un archivo hist√≥rico. Los registros archivados no se mostrar√°n en la bit√°cora principal pero podr√°n consultarse en Reportes > Auditor√≠a Archivada.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Archivar registros anteriores a:</label>
                    <input type="date" id="archiveDate" class="form-control" required>
                </div>

                <div style="margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="archiveConfirm" required>
                        Entiendo que esta acci√≥n no se puede deshacer
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="auditModule.closeArchiveModal()">Cancelar</button>
                <button class="btn btn-warning" onclick="auditModule.executeArchive()">Archivar Registros</button>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div style="margin-top: 16px; color: var(--text-secondary);">Procesando...</div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">
        <div id="toastMessage"></div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyANa6zWkGrYQ7O7M6XT2oYbArsZIcs36M8",
            authDomain: "trip-a9341.firebaseapp.com",
            databaseURL: "https://trip-a9341-default-rtdb.firebaseio.com",
            projectId: "trip-a9341",
            storageBucket: "trip-a9341.firebasestorage.app",
            messagingSenderId: "379336201132",
            appId: "1:379336201132:web:34b0b863c3462c12aba009",
            measurementId: "G-PJQ32ZXJ0B"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ==========================================
        // UTILIDADES GLOBALES
        // ==========================================
        const utils = {
            formatMoney: (amount) => {
                return new Intl.NumberFormat('es-EC', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount || 0);
            },

            formatDate: (date) => {
                if (!date || date === 'Invalid Date') return '-';
                const d = new Date(date);
                if (isNaN(d.getTime())) return '-';
                return d.toLocaleDateString('es-EC');
            },

            formatDateTime: (timestamp) => {
                if (!timestamp) return '-';
                const d = new Date(timestamp);
                return d.toLocaleString('es-EC');
            },

            generateId: () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
            },

            calculateAge: (birthDate) => {
                if (!birthDate) return 0;
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            },

            showToast: (message, type = 'success') => {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                toastMessage.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => toast.classList.remove('show'), 3000);
            },

            showLoading: (show) => {
                document.getElementById('loadingOverlay').classList.toggle('active', show);
            },

            getToday: () => new Date().toISOString().split('T')[0],

            addMonths: (date, months) => {
                const d = new Date(date);
                d.setMonth(d.getMonth() + months);
                return d;
            },

            calculateDueDays: (dueDate) => {
                if (!dueDate) return 0;
                const today = new Date();
                today.setHours(0,0,0,0);
                const due = new Date(dueDate);
                if (isNaN(due.getTime())) return 0;
                const diff = Math.floor((today - due) / (1000 * 60 * 60 * 24));
                return diff > 0 ? diff : 0;
            },

            showError: (elementId, message) => {
                const el = document.getElementById(elementId);
                if (el) {
                    el.textContent = message;
                    el.classList.remove('hidden');
                    setTimeout(() => el.classList.add('hidden'), 5000);
                }
            },

            exportToExcel: (data, filename, sheetName = 'Datos') => {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                XLSX.writeFile(wb, filename + '.xlsx');
            }
        };

        let currentUser = null;
        let currentUserData = null;

        // ==========================================
        // PLAN DE CUENTAS COMPLETO NIIF - ECUADOR
        // ==========================================
        const planCuentasCompleto = [
            // ACTIVOS (1)
            { codigo: '1', nombre: 'ACTIVO', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 1 },
            { codigo: '1.1', nombre: 'ACTIVO CORRIENTE', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 2 },
            { codigo: '1.1.1', nombre: 'EFECTIVO Y EQUIVALENTES', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '1.1.1.01', nombre: 'Caja', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.1.02', nombre: 'Bancos', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.1.03', nombre: 'Fondos de Inversi√≥n a Corto Plazo', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.2', nombre: 'INVERSIONES FINANCIERAS', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '1.1.2.01', nombre: 'Cartera de Cr√©ditos', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.2.01.01', nombre: 'Cr√©ditos de Consumo', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 5 },
            { codigo: '1.1.2.01.02', nombre: 'Cr√©ditos de Vivienda', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 5 },
            { codigo: '1.1.2.01.03', nombre: 'Cr√©ditos Comerciales', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 5 },
            { codigo: '1.1.2.01.04', nombre: 'Cr√©ditos Microempresa', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 5 },
            { codigo: '1.1.2.02', nombre: 'Provisi√≥n para Cartera Incobrable', tipo: 'ACTIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '1.1.2.03', nombre: 'Intereses por Cobrar', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.3', nombre: 'CUENTAS POR COBRAR', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '1.1.3.01', nombre: 'Cuentas por Cobrar Clientes', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.3.02', nombre: 'Documentos por Cobrar', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.3.03', nombre: 'Anticipo a Proveedores', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.4', nombre: 'INVENTARIOS', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '1.1.4.01', nombre: 'Bienes para la Venta', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.5', nombre: 'GASTOS PAGADOS POR ANTICIPADO', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '1.1.5.01', nombre: 'Seguros Pagados por Anticipado', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.1.5.02', nombre: 'Alquileres Pagados por Anticipado', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.2', nombre: 'ACTIVO NO CORRIENTE', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 2 },
            { codigo: '1.2.1', nombre: 'PROPIEDADES, PLANTA Y EQUIPO', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '1.2.1.01', nombre: 'Terrenos', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.2.1.02', nombre: 'Edificios', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.2.1.03', nombre: 'Mobiliario y Equipo de Oficina', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.2.1.04', nombre: 'Veh√≠culos', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.2.1.05', nombre: 'Equipo de C√≥mputo', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.2.1.99', nombre: 'Depreciaci√≥n Acumulada', tipo: 'ACTIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '1.2.2', nombre: 'INTANGIBLES', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '1.2.2.01', nombre: 'Software', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '1.2.2.02', nombre: 'Licencias', tipo: 'ACTIVO', naturaleza: 'DEUDOR', nivel: 4 },
            
            // PASIVOS (2)
            { codigo: '2', nombre: 'PASIVO', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 1 },
            { codigo: '2.1', nombre: 'PASIVO CORRIENTE', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 2 },
            { codigo: '2.1.1', nombre: 'OBLIGACIONES CON INSTITUCIONES FINANCIERAS', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '2.1.1.01', nombre: 'Obligaciones con Bancos', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.1.02', nombre: 'Pagar√©s Bancarios', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.2', nombre: 'CUENTAS POR PAGAR', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '2.1.2.01', nombre: 'Proveedores Locales', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.2.02', nombre: 'Proveedores del Exterior', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.2.03', nombre: 'Documentos por Pagar', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.3', nombre: 'OBLIGACIONES LABORALES', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '2.1.3.01', nombre: 'Sueldos por Pagar', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.3.02', nombre: 'Beneficios Sociales por Pagar', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.3.03', nombre: 'Aportes Patronales por Pagar', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.4', nombre: 'OBLIGACIONES FISCALES', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '2.1.4.01', nombre: 'IVA por Pagar', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.4.02', nombre: 'Retenciones en la Fuente por Pagar', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.4.03', nombre: 'Impuesto a la Renta por Pagar', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.5', nombre: 'PASIVOS POR CONCEPTOS DE FONDOS', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '2.1.5.01', nombre: 'Dep√≥sitos de Ahorro', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.5.02', nombre: 'Dep√≥sitos a Plazo', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.1.5.03', nombre: 'Cuentas Corrientes', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '2.2', nombre: 'PASIVO NO CORRIENTE', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 2 },
            { codigo: '2.2.1', nombre: 'OBLIGACIONES BANCARIAS LARGO PLAZO', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '2.2.1.01', nombre: 'Deudas Bancarias Largo Plazo', tipo: 'PASIVO', naturaleza: 'ACREEDOR', nivel: 4 },
            
            // PATRIMONIO (3)
            { codigo: '3', nombre: 'PATRIMONIO', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 1 },
            { codigo: '3.1', nombre: 'CAPITAL', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 2 },
            { codigo: '3.1.1', nombre: 'CAPITAL SOCIAL', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '3.1.1.01', nombre: 'Capital Suscrito', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '3.1.1.02', nombre: 'Capital Pagado', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '3.1.2', nombre: 'RESERVAS', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '3.1.2.01', nombre: 'Reserva Legal', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '3.1.2.02', nombre: 'Reserva Facultativa', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '3.1.3', nombre: 'RESULTADOS', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '3.1.3.01', nombre: 'Utilidades Retenidas', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '3.1.3.02', nombre: 'P√©rdidas Acumuladas', tipo: 'PATRIMONIO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '3.1.3.03', nombre: 'Resultado del Ejercicio', tipo: 'PATRIMONIO', naturaleza: 'ACREEDOR', nivel: 4 },
            
            // INGRESOS (4)
            { codigo: '4', nombre: 'INGRESOS', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 1 },
            { codigo: '4.1', nombre: 'INGRESOS DE OPERACI√ìN', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 2 },
            { codigo: '4.1.1', nombre: 'INGRESOS FINANCIEROS', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '4.1.1.01', nombre: 'Intereses Ganados - Cartera', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '4.1.1.02', nombre: 'Intereses Ganados - Inversiones', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '4.1.1.03', nombre: 'Intereses por Mora', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '4.1.2', nombre: 'COMISIONES Y TARIFAS', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '4.1.2.01', nombre: 'Comisiones por Apertura', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '4.1.2.02', nombre: 'Comisiones por Manejo de Cuenta', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '4.1.2.03', nombre: 'Comisiones por Transferencias', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '4.1.3', nombre: 'OTROS INGRESOS', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '4.1.3.01', nombre: 'Recuperaci√≥n de Deudas Incobrables', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 4 },
            { codigo: '4.1.3.02', nombre: 'Ingresos por Servicios', tipo: 'INGRESO', naturaleza: 'ACREEDOR', nivel: 4 },
            
            // GASTOS (5)
            { codigo: '5', nombre: 'GASTOS', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 1 },
            { codigo: '5.1', nombre: 'GASTOS DE OPERACI√ìN', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 2 },
            { codigo: '5.1.1', nombre: 'GASTOS ADMINISTRATIVOS', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '5.1.1.01', nombre: 'Sueldos y Salarios', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.02', nombre: 'Beneficios Sociales', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.03', nombre: 'Aportes Patronales', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.04', nombre: 'Honorarios Profesionales', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.05', nombre: 'Alquileres', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.06', nombre: 'Servicios P√∫blicos', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.07', nombre: 'Mantenimiento y Reparaciones', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.08', nombre: 'Suministros y Materiales', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.09', nombre: 'Seguros', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.1.10', nombre: 'Publicidad y Propaganda', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.2', nombre: 'GASTOS FINANCIEROS', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '5.1.2.01', nombre: 'Intereses Pagados', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.2.02', nombre: 'Comisiones Bancarias', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.3', nombre: 'GASTOS DE DEPRECIACI√ìN Y AMORTIZACI√ìN', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '5.1.3.01', nombre: 'Depreciaci√≥n Propiedades, Planta y Equipo', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.3.02', nombre: 'Amortizaci√≥n Intangibles', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.4', nombre: 'PROVISIONES', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '5.1.4.01', nombre: 'Provisi√≥n Cartera Incobrable', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.4.02', nombre: 'Provisi√≥n Desvalorizaci√≥n Inventarios', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.5', nombre: 'OTROS GASTOS', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '5.1.5.01', nombre: 'P√©rdida en Venta de Activos', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.5.02', nombre: 'Gastos de Capacitaci√≥n', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '5.1.5.03', nombre: 'Gastos de Viaje', tipo: 'GASTO', naturaleza: 'DEUDOR', nivel: 4 },
            
            // CUENTAS DE ORDEN (6)
            { codigo: '6', nombre: 'CUENTAS DE ORDEN', tipo: 'ORDEN', naturaleza: 'DEUDOR', nivel: 1 },
            { codigo: '6.1', nombre: 'CUENTAS DE CONTROL', tipo: 'ORDEN', naturaleza: 'DEUDOR', nivel: 2 },
            { codigo: '6.1.1', nombre: 'BIENES EN CUSTODIA', tipo: 'ORDEN', naturaleza: 'DEUDOR', nivel: 3 },
            { codigo: '6.1.1.01', nombre: 'Garant√≠as Recibidas', tipo: 'ORDEN', naturaleza: 'DEUDOR', nivel: 4 },
            { codigo: '6.1.2', nombre: 'COMPROMISOS CONTRA√çDOS', tipo: 'ORDEN', naturaleza: 'ACREEDOR', nivel: 3 },
            { codigo: '6.1.2.01', nombre: 'Contratos de Cr√©dito Aprobados', tipo: 'ORDEN', naturaleza: 'ACREEDOR', nivel: 4 }
        ];

        // ==========================================
        // DATOS GEOGR√ÅFICOS ECUADOR
        // ==========================================
        const ecuadorData = {
            provincias: {
                "AZUAY": ["Cuenca", "Gir√≥n", "Gualaceo", "Nab√≥n", "Paute", "Pucar√°", "San Fernando", "Santa Isabel", "Sigsig", "O√±a", "Chordeleg", "El Pan", "Sevilla de Oro", "Guachapala", "Camilo Ponce Enr√≠quez"],
                "BOLIVAR": ["Guaranda", "San Miguel", "Chillanes", "Chimbo", "Echeand√≠a", "Las Naves"],
                "CA√ëAR": ["Azogues", "Bibli√°n", "Ca√±ar", "La Troncal", "El Tambo", "D√©leg", "Suscal"],
                "CARCHI": ["Tulc√°n", "Bol√≠var", "Espejo", "Mira", "Mont√∫far", "San Pedro de Huaca"],
                "CHIMBORAZO": ["Riobamba", "Alaus√≠", "Colta", "Chambo", "Chunchi", "Guamote", "Guano", "Pallatanga", "Penipe", "Cumand√°"],
                "COTOPAXI": ["Latacunga", "La Man√°", "Pangua", "Pujil√≠", "Salcedo", "Saquisil√≠", "Sigchos"],
                "EL_ORO": ["Machala", "Arenillas", "Atahualpa", "Balsas", "Chilla", "El Guabo", "Huaquillas", "Las Lajas", "Marcabel√≠", "Pasaje", "Pi√±as", "Portovelo", "Santa Rosa", "Zaruma"],
                "ESMERALDAS": ["Esmeraldas", "Eloy Alfaro", "Muisne", "Quinind√©", "San Lorenzo", "Atacames", "Rioverde", "La Concordia"],
                "GALAPAGOS": ["San Crist√≥bal", "Isabela", "Santa Cruz"],
                "GUAYAS": ["Guayaquil", "Alfredo Baquerizo Moreno", "Balao", "Balzar", "Colimes", "Daule", "Dur√°n", "El Empalme", "El Triunfo", "Milagro", "Naranjal", "Naranjito", "Palestina", "Pedro Carbo", "Samborond√≥n", "Santa Luc√≠a", "Playas", "Sim√≥n Bol√≠var", "San Jacinto de Yaguachi", "El Colorado", "General Antonio Elizalde", "Isidro Ayora", "Lomas de Sargentillo", "Marcelino Maridue√±a", "Nobol", "Antonio Sotomayor"],
                "IMBABURA": ["Ibarra", "Antonio Ante", "Cotacachi", "Otavalo", "Pimampiro", "San Miguel de Urcuqu√≠"],
                "LOJA": ["Loja", "Calvas", "Catamayo", "Celica", "Chaguarpamba", "Esp√≠ndola", "Gonzanam√°", "Macar√°", "Paltas", "Puyango", "Saraguro", "Sozoranga", "Zapotillo", "Pindal", "Quilanga", "Olmedo"],
                "LOS_RIOS": ["Babahoyo", "Baba", "Buena F√©", "Mocache", "Montalvo", "Palenque", "Pueblo Viejo", "Quevedo", "Urdaneta", "Ventanas", "Vinces", "Quinsaloma"],
                "MANABI": ["Portoviejo", "Bol√≠var", "Chone", "El Carmen", "Flavio Alfaro", "Jipijapa", "Jun√≠n", "Manta", "Montecristi", "Paj√°n", "Pichincha", "Rocafuerte", "Santa Ana", "Sucre", "Tosagua", "24 de Mayo", "Pedernales", "Olmedo", "Puerto L√≥pez", "Jama", "San Vicente"],
                "MORONA_SANTIAGO": ["Macas", "Gualaquiza", "Lim√≥n Indanza", "Palora", "Santiago", "Suc√∫a", "Huamboya", "San Juan Bosco", "Taisha", "Logro√±o", "Pablo Sexto", "Tiwintza"],
                "NAPO": ["Tena", "Archidona", "El Chaco", "Quijos", "Carlos Julio Arosemena Tola"],
                "ORELLANA": ["Francisco de Orellana", "Aguarico", "La Joya de los Sachas", "Loreto"],
                "PASTAZA": ["Puyo", "Mera", "Santa Clara", "Arajuno"],
                "PICHINCHA": ["Quito", "Cayambe", "Mej√≠a", "Pedro Moncayo", "Rumi√±ahui", "San Miguel de los Bancos", "Pedro Vicente Maldonado", "Puerto Quito"],
                "SANTA_ELENA": ["Santa Elena", "La Libertad", "Salinas"],
                "SANTO_DOMINGO": ["Santo Domingo", "La Concordia"],
                "SUCUMBIOS": ["Nueva Loja", "Gonzalo Pizarro", "Putumayo", "Shushufindi", "Sucumb√≠os", "Cascales", "Cuyabeno"],
                "TUNGURAHUA": ["Ambato", "Ba√±os de Agua Santa", "Cevallos", "Mocha", "Patate", "Quero", "San Pedro de Pelileo", "Santiago de P√≠llaro", "Tisaleo"],
                "ZAMORA_CHINCHIPE": ["Zamora", "Chinchipe", "Nangaritza", "Yacuambi", "Yantzaza", "El Pangui", "Centinela del C√≥ndor", "Palanda", "Paquisha"]
            }
        };

        // ==========================================
        // M√ìDULO AUTENTICACI√ìN
        // ==========================================
        const authModule = {
            init: () => {
                // Escuchar cambios en el estado de autenticaci√≥n
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        authModule.loadUserData(user.uid);
                    } else {
                        authModule.showLogin();
                    }
                });

                // Actualizar fecha/hora en el header
                setInterval(() => {
                    const el = document.getElementById('currentDateTime');
                    if (el) el.textContent = new Date().toLocaleString('es-EC');
                }, 1000);
            },

            loadUserData: (uid) => {
                database.ref('usuarios/' + uid).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            currentUserData = snapshot.val();
                            document.getElementById('currentUserName').textContent = currentUserData.nombre || 'Administrador';
                            authModule.showApp();
                            dashboardModule.init();
                        } else {
                            // Crear datos de usuario si no existen
                            const userData = {
                                nombre: currentUser.email.split('@')[0],
                                email: currentUser.email,
                                rol: 'admin',
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            };
                            return database.ref('usuarios/' + uid).set(userData).then(() => {
                                currentUserData = userData;
                                document.getElementById('currentUserName').textContent = userData.nombre;
                                authModule.showApp();
                                dashboardModule.init();
                            });
                        }
                    })
                    .catch((error) => {
                        console.error("Error cargando datos de usuario:", error);
                        authModule.showLogin();
                    });
            },

            showLogin: () => {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('registerScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('active');
            },

            showRegister: () => {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('registerScreen').classList.remove('hidden');
            },

            showApp: () => {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('registerScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('active');
            },

            login: (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const btn = document.getElementById('loginBtn');

                btn.disabled = true;
                btn.textContent = 'Iniciando sesi√≥n...';

                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        utils.showToast('Sesi√≥n iniciada correctamente');
                    })
                    .catch((error) => {
                        let message = 'Error al iniciar sesi√≥n';
                        if (error.code === 'auth/user-not-found') message = 'Usuario no encontrado';
                        if (error.code === 'auth/wrong-password') message = 'Contrase√±a incorrecta';
                        if (error.code === 'auth/invalid-email') message = 'Email inv√°lido';
                        if (error.code === 'auth/too-many-requests') message = 'Demasiados intentos. Intente m√°s tarde';
                        
                        utils.showError('loginError', message);
                        btn.disabled = false;
                        btn.textContent = 'Iniciar Sesi√≥n';
                    });
            },

            register: (e) => {
                e.preventDefault();
                const nombre = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;
                const confirmPassword = document.getElementById('regConfirmPassword').value;
                const btn = document.getElementById('registerBtn');

                if (password !== confirmPassword) {
                    utils.showError('registerError', 'Las contrase√±as no coinciden');
                    return;
                }

                if (password.length < 6) {
                    utils.showError('registerError', 'La contrase√±a debe tener al menos 6 caracteres');
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Creando cuenta...';

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        return database.ref('usuarios/' + user.uid).set({
                            nombre: nombre,
                            email: email,
                            rol: 'admin',
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    })
                    .then(() => {
                        document.getElementById('registerSuccess').textContent = 'Cuenta creada exitosamente. Iniciando sesi√≥n...';
                        document.getElementById('registerSuccess').classList.remove('hidden');
                        setTimeout(() => {
                            authModule.showApp();
                            dashboardModule.init();
                        }, 1500);
                    })
                    .catch((error) => {
                        let message = 'Error al crear cuenta';
                        if (error.code === 'auth/email-already-in-use') message = 'El email ya est√° registrado';
                        if (error.code === 'auth/invalid-email') message = 'Email inv√°lido';
                        if (error.code === 'auth/weak-password') message = 'Contrase√±a d√©bil';
                        
                        utils.showError('registerError', message);
                        btn.disabled = false;
                        btn.textContent = 'Crear Cuenta';
                    });
            },

            logout: () => {
                auth.signOut().then(() => {
                    currentUser = null;
                    currentUserData = null;
                    utils.showToast('Sesi√≥n cerrada');
                    authModule.showLogin();
                });
            }
        };

        // ==========================================
        // M√ìDULO NAVEGACI√ìN
        // ==========================================
        const navModule = {
            show: (moduleName) => {
                document.querySelectorAll('.module-container').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                document.getElementById('module-' + moduleName).classList.add('active');
                event.target.classList.add('active');

                switch(moduleName) {
                    case 'clients': clientModule.init(); break;
                    case 'credits': creditModule.init(); break;
                    case 'payments': paymentModule.init(); break;
                    case 'accounting': accountingModule.init(); break;
                    case 'reports': reportModule.init(); break;
                    case 'config': configModule.init(); break;
                    case 'audit': auditModule.init(); break;
                }
            }
        };

        // ==========================================
        // M√ìDULO DASHBOARD
        // ==========================================
        const dashboardModule = {
            init: () => {
                dashboardModule.refresh();
            },

            refresh: () => {
                // Cartera activa
                database.ref('creditos').orderByChild('estado').equalTo('ACTIVO').once('value', (snapshot) => {
                    let totalPortfolio = 0;
                    let totalInterest = 0;
                    let pastDue = 0;
                    let pastDueCount = 0;
                    let todayPayments = 0;

                    const today = utils.getToday();

                    snapshot.forEach((child) => {
                        const credit = child.val();
                        totalPortfolio += parseFloat(credit.saldoActual || 0);
                        totalInterest += parseFloat(credit.interesPendiente || 0);
                        
                        if (credit.diasMora > 0) {
                            pastDue += parseFloat(credit.saldoActual || 0);
                            pastDueCount++;
                        }
                    });

                    document.getElementById('statTotalPortfolio').textContent = utils.formatMoney(totalPortfolio);
                    document.getElementById('statTotalInterest').textContent = utils.formatMoney(totalInterest);
                    document.getElementById('statPastDue').textContent = utils.formatMoney(pastDue);
                    document.getElementById('statPastDueCount').textContent = pastDueCount + ' cr√©ditos en mora';

                    // Pagos de hoy
                    database.ref('pagos').orderByChild('fecha').equalTo(today).once('value', (paySnapshot) => {
                        paySnapshot.forEach((child) => {
                            todayPayments += parseFloat(child.val().monto || 0);
                        });
                        document.getElementById('statTodayPayments').textContent = utils.formatMoney(todayPayments);
                    });
                });

                // Contar clientes
                database.ref('clientes').once('value', (snapshot) => {
                    document.getElementById('statActiveClients').textContent = snapshot.numChildren();
                });

                // Cr√©ditos recientes
                database.ref('creditos').limitToLast(5).once('value', (snapshot) => {
                    const tbody = document.getElementById('recentCreditsTable');
                    tbody.innerHTML = '';
                    
                    const credits = [];
                    snapshot.forEach((child) => {
                        credits.push({ id: child.key, ...child.val() });
                    });
                    credits.reverse();

                    if (credits.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No hay cr√©ditos</td></tr>';
                        return;
                    }

                    credits.forEach(credit => {
                        database.ref('clientes/' + credit.clienteId).once('value', (clientSnap) => {
                            const client = clientSnap.val();
                            const row = `
                                <tr>
                                    <td>${credit.id.substr(-6)}</td>
                                    <td>${client ? client.nombres + ' ' + client.apellidos : 'N/A'}</td>
                                    <td>${utils.formatMoney(credit.monto)}</td>
                                    <td><span class="badge badge-${credit.estado === 'ACTIVO' ? 'success' : (credit.estado === 'CANCELADO' ? 'info' : 'danger')}">${credit.estado}</span></td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    });
                });

                // Pagos recientes
                database.ref('pagos').limitToLast(5).once('value', (snapshot) => {
                    const tbody = document.getElementById('recentPaymentsTable');
                    tbody.innerHTML = '';
                    
                    const payments = [];
                    snapshot.forEach((child) => {
                        payments.push(child.val());
                    });
                    payments.reverse();

                    if (payments.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No hay pagos</td></tr>';
                        return;
                    }

                    payments.forEach(payment => {
                        const row = `
                            <tr>
                                <td>${utils.formatDate(payment.fecha)}</td>
                                <td>${payment.clienteNombre || 'N/A'}</td>
                                <td>${utils.formatMoney(payment.monto)}</td>
                                <td><span class="badge badge-info">${payment.tipo}</span></td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                });
            }
        };

        // ==========================================
        // M√ìDULO CLIENTES
        // ==========================================
        const clientModule = {
            clients: {},
            editingId: null,

            init: () => {
                clientModule.loadProvincias();
                clientModule.loadClients();
            },

            loadProvincias: () => {
                const select = document.getElementById('clientProvincia');
                select.innerHTML = '<option value="">Seleccione...</option>';
                Object.keys(ecuadorData.provincias).forEach(prov => {
                    select.innerHTML += `<option value="${prov}">${prov.replace(/_/g, ' ')}</option>`;
                });
            },

            loadCantones: () => {
                const provincia = document.getElementById('clientProvincia').value;
                const select = document.getElementById('clientCanton');
                select.innerHTML = '<option value="">Seleccione...</option>';
                
                if (provincia && ecuadorData.provincias[provincia]) {
                    ecuadorData.provincias[provincia].forEach(canton => {
                        select.innerHTML += `<option value="${canton}">${canton}</option>`;
                    });
                }
            },

            loadClients: () => {
                utils.showLoading(true);
                database.ref('clientes').once('value', (snapshot) => {
                    clientModule.clients = snapshot.val() || {};
                    clientModule.renderClients();
                    utils.showLoading(false);
                });
            },

            renderClients: () => {
                const tbody = document.getElementById('clientsTable');
                tbody.innerHTML = '';
                
                const search = document.getElementById('clientSearch')?.value.toLowerCase() || '';

                Object.entries(clientModule.clients).forEach(([id, client]) => {
                    const fullName = `${client.nombres || ''} ${client.apellidos || ''}`.toLowerCase();
                    const doc = (client.numeroDocumento || '').toLowerCase();
                    const phone = (client.telefono || '').toLowerCase();
                    
                    if (search && !fullName.includes(search) && !doc.includes(search) && !phone.includes(search)) {
                        return;
                    }

                    const capacidad = ((parseFloat(client.ingresosMensuales || 0) + parseFloat(client.otrosIngresos || 0) - parseFloat(client.gastosMensuales || 0)) * 0.4);
                    
                    // Contar cr√©ditos activos
                    database.ref('creditos').orderByChild('clienteId').equalTo(id).once('value', (snap) => {
                        let creditosActivos = 0;
                        snap.forEach((child) => {
                            if (child.val().estado === 'ACTIVO') creditosActivos++;
                        });

                        const row = `
                            <tr>
                                <td>${id.substr(-6)}</td>
                                <td>${client.tipoDocumento || 'CEDULA'}: ${client.numeroDocumento || '-'}</td>
                                <td>${client.apellidos || ''}, ${client.nombres || ''}</td>
                                <td>${client.telefono || '-'}<br><span class="text-muted">${client.email || ''}</span></td>
                                <td>${utils.formatMoney(capacidad)}</td>
                                <td>${creditosActivos}</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="clientModule.edit('${id}')">Editar</button>
                                    <button class="btn btn-sm btn-info" onclick="clientModule.viewDetail('${id}')">Ver</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                });

                if (tbody.innerHTML === '') {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron clientes</td></tr>';
                }
            },

            search: () => {
                clientModule.renderClients();
            },

            clearFilters: () => {
                document.getElementById('clientSearch').value = '';
                clientModule.renderClients();
            },

            calcularEdad: () => {
                const fechaNac = document.getElementById('clientFechaNac').value;
                const edad = utils.calculateAge(fechaNac);
                document.getElementById('clientEdad').value = edad > 0 ? edad + ' a√±os' : '';
            },

            calcularCapacidad: () => {
                const ingresos = parseFloat(document.getElementById('clientIngresos').value) || 0;
                const otros = parseFloat(document.getElementById('clientOtrosIngresos').value) || 0;
                const gastos = parseFloat(document.getElementById('clientGastos').value) || 0;
                const capacidad = (ingresos + otros - gastos) * 0.4;
                document.getElementById('clientCapacidad').value = utils.formatMoney(capacidad) + ' /mes';
            },

            showCreateModal: () => {
                clientModule.editingId = null;
                document.getElementById('clientModalTitle').textContent = 'Nuevo Cliente';
                document.getElementById('clientForm').reset();
                document.getElementById('clientId').value = '';
                document.getElementById('modalClient').classList.add('active');
            },

            edit: (id) => {
                clientModule.editingId = id;
                const client = clientModule.clients[id];
                if (!client) return;

                document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
                document.getElementById('clientId').value = id;
                document.getElementById('clientTipoDoc').value = client.tipoDocumento || 'CEDULA';
                document.getElementById('clientNumDoc').value = client.numeroDocumento || '';
                document.getElementById('clientNombres').value = client.nombres || '';
                document.getElementById('clientApellidos').value = client.apellidos || '';
                document.getElementById('clientFechaNac').value = client.fechaNacimiento || '';
                document.getElementById('clientTelefono').value = client.telefono || '';
                document.getElementById('clientTelefono2').value = client.telefonoSecundario || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientDireccion').value = client.direccion || '';
                document.getElementById('clientProvincia').value = client.provincia || '';
                clientModule.loadCantones();
                document.getElementById('clientCanton').value = client.canton || '';
                document.getElementById('clientProfesion').value = client.profesion || '';
                document.getElementById('clientEmpresa').value = client.empresa || '';
                document.getElementById('clientIngresos').value = client.ingresosMensuales || 0;
                document.getElementById('clientOtrosIngresos').value = client.otrosIngresos || 0;
                document.getElementById('clientGastos').value = client.gastosMensuales || 0;
                document.getElementById('clientBanco').value = client.banco || '';
                document.getElementById('clientTipoCuenta').value = client.tipoCuenta || 'AHORROS';
                document.getElementById('clientNumCuenta').value = client.numeroCuenta || '';

                clientModule.calcularEdad();
                clientModule.calcularCapacidad();
                document.getElementById('modalClient').classList.add('active');
            },

            closeModal: () => {
                document.getElementById('modalClient').classList.remove('active');
            },

            save: (e) => {
                e.preventDefault();
                utils.showLoading(true);

                const id = document.getElementById('clientId').value || utils.generateId();
                const clientData = {
                    tipoDocumento: document.getElementById('clientTipoDoc').value,
                    numeroDocumento: document.getElementById('clientNumDoc').value,
                    nombres: document.getElementById('clientNombres').value,
                    apellidos: document.getElementById('clientApellidos').value,
                    fechaNacimiento: document.getElementById('clientFechaNac').value,
                    telefono: document.getElementById('clientTelefono').value,
                    telefonoSecundario: document.getElementById('clientTelefono2').value,
                    email: document.getElementById('clientEmail').value,
                    direccion: document.getElementById('clientDireccion').value,
                    provincia: document.getElementById('clientProvincia').value,
                    canton: document.getElementById('clientCanton').value,
                    profesion: document.getElementById('clientProfesion').value,
                    empresa: document.getElementById('clientEmpresa').value,
                    ingresosMensuales: parseFloat(document.getElementById('clientIngresos').value) || 0,
                    otrosIngresos: parseFloat(document.getElementById('clientOtrosIngresos').value) || 0,
                    gastosMensuales: parseFloat(document.getElementById('clientGastos').value) || 0,
                    banco: document.getElementById('clientBanco').value,
                    tipoCuenta: document.getElementById('clientTipoCuenta').value,
                    numeroCuenta: document.getElementById('clientNumCuenta').value,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: currentUser.uid
                };

                if (!clientModule.editingId) {
                    clientData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                    clientData.createdBy = currentUser.uid;
                }

                database.ref('clientes/' + id).set(clientData)
                    .then(() => {
                        auditModule.log(clientModule.editingId ? 'update' : 'create', 'cliente', id, 
                            `${clientModule.editingId ? 'Actualizaci√≥n' : 'Creaci√≥n'} de cliente: ${clientData.nombres} ${clientData.apellidos}`);
                        
                        utils.showLoading(false);
                        utils.showToast(clientModule.editingId ? 'Cliente actualizado' : 'Cliente guardado exitosamente');
                        clientModule.closeModal();
                        clientModule.loadClients();
                    })
                    .catch((error) => {
                        utils.showLoading(false);
                        utils.showToast('Error: ' + error.message, 'error');
                    });
            },

            viewDetail: (id) => {
                const client = clientModule.clients[id];
                if (!client) return;

                Promise.all([
                    database.ref('creditos').orderByChild('clienteId').equalTo(id).once('value'),
                    database.ref('pagos').orderByChild('clienteId').equalTo(id).once('value')
                ]).then(([creditsSnap, paymentsSnap]) => {
                    const credits = creditsSnap.val() || {};
                    const payments = paymentsSnap.val() || {};

                    let creditsHtml = '';
                    let totalCreditos = 0;
                    let totalSaldo = 0;
                    Object.entries(credits).forEach(([creditId, credit]) => {
                        totalCreditos += credit.monto;
                        totalSaldo += credit.saldoActual || 0;
                        creditsHtml += `
                            <tr>
                                <td>${creditId.substr(-6)}</td>
                                <td>${utils.formatDate(credit.fechaDesembolso)}</td>
                                <td>${utils.formatMoney(credit.monto)}</td>
                                <td>${utils.formatMoney(credit.saldoActual)}</td>
                                <td>${utils.formatMoney(credit.cuotaMensual)}</td>
                                <td><span class="badge badge-${credit.estado === 'ACTIVO' ? 'success' : (credit.estado === 'CANCELADO' ? 'info' : 'danger')}">${credit.estado}</span></td>
                            </tr>
                        `;
                    });

                    let paymentsHtml = '';
                    let totalPagado = 0;
                    Object.entries(payments).forEach(([paymentId, pago]) => {
                        if (pago.estado === 'ANULADO') return;
                        totalPagado += pago.monto;
                        paymentsHtml += `
                            <tr>
                                <td>${utils.formatDate(pago.fecha)}</td>
                                <td>${pago.creditoId?.substr(-6)}</td>
                                <td>${pago.tipo}</td>
                                <td>${utils.formatMoney(pago.monto)}</td>
                                <td>${pago.metodo}</td>
                            </tr>
                        `;
                    });

                    const content = document.getElementById('clientDetailContent');
                    content.innerHTML = `
                        <div class="detail-view">
                            <div class="detail-row"><div class="detail-label">Documento:</div><div>${client.tipoDocumento}: ${client.numeroDocumento}</div></div>
                            <div class="detail-row"><div class="detail-label">Nombre:</div><div>${client.nombres} ${client.apellidos}</div></div>
                            <div class="detail-row"><div class="detail-label">Fecha Nac.:</div><div>${utils.formatDate(client.fechaNacimiento)}</div></div>
                            <div class="detail-row"><div class="detail-label">Tel√©fono:</div><div>${client.telefono} / ${client.telefonoSecundario || ''}</div></div>
                            <div class="detail-row"><div class="detail-label">Email:</div><div>${client.email}</div></div>
                            <div class="detail-row"><div class="detail-label">Direcci√≥n:</div><div>${client.direccion}</div></div>
                            <div class="detail-row"><div class="detail-label">Ubicaci√≥n:</div><div>${client.provincia || ''} - ${client.canton || ''}</div></div>
                            <div class="detail-row"><div class="detail-label">Profesi√≥n:</div><div>${client.profesion || ''}</div></div>
                            <div class="detail-row"><div class="detail-label">Empresa:</div><div>${client.empresa || ''}</div></div>
                            <div class="detail-row"><div class="detail-label">Ingresos/Gastos:</div><div>Ing: ${utils.formatMoney(client.ingresosMensuales)} - Gast: ${utils.formatMoney(client.gastosMensuales)}</div></div>
                            <div class="detail-row"><div class="detail-label">Capacidad:</div><div style="font-weight:bold;color:var(--primary-blue);">${utils.formatMoney((client.ingresosMensuales + (client.otrosIngresos||0) - client.gastosMensuales) * 0.4)}/mes</div></div>
                            <div class="detail-row"><div class="detail-label">Banco:</div><div>${client.banco || ''} - ${client.tipoCuenta || ''} ${client.numeroCuenta || ''}</div></div>
                        </div>
                        <h4 style="margin:20px 0 10px;color:var(--primary-blue);">Resumen Financiero</h4>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
                            <div style="background:#f0f9ff;padding:10px;border-radius:8px;text-align:center;">
                                <div>Total Cr√©ditos</div><div style="font-size:18px;font-weight:bold;">${utils.formatMoney(totalCreditos)}</div>
                            </div>
                            <div style="background:#f0fdf4;padding:10px;border-radius:8px;text-align:center;">
                                <div>Total Pagado</div><div style="font-size:18px;font-weight:bold;color:var(--success);">${utils.formatMoney(totalPagado)}</div>
                            </div>
                            <div style="background:#fef3c7;padding:10px;border-radius:8px;text-align:center;">
                                <div>Saldo Pendiente</div><div style="font-size:18px;font-weight:bold;color:var(--warning);">${utils.formatMoney(totalSaldo)}</div>
                            </div>
                        </div>
                        <h4 style="margin:20px 0 10px;color:var(--primary-blue);">Cr√©ditos</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead><tr><th>No.</th><th>Fecha</th><th>Monto</th><th>Saldo</th><th>Cuota</th><th>Estado</th></tr></thead>
                                <tbody>${creditsHtml || '<tr><td colspan="6">Sin cr√©ditos</td></tr>'}</tbody>
                            </table>
                        </div>
                        <h4 style="margin:20px 0 10px;color:var(--primary-blue);">Pagos</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead><tr><th>Fecha</th><th>Cr√©dito</th><th>Tipo</th><th>Monto</th><th>M√©todo</th></tr></thead>
                                <tbody>${paymentsHtml || '<tr><td colspan="5">Sin pagos</td></tr>'}</tbody>
                            </table>
                        </div>
                    `;
                    document.getElementById('modalClientDetail').classList.add('active');
                });
            },

            closeDetailModal: () => {
                document.getElementById('modalClientDetail').classList.remove('active');
            },

            printDetail: () => {
                window.print();
            },

            exportToExcel: () => {
                const data = Object.entries(clientModule.clients).map(([id, c]) => ({
                    ID: id,
                    Tipo_Doc: c.tipoDocumento,
                    Documento: c.numeroDocumento,
                    Nombres: c.nombres,
                    Apellidos: c.apellidos,
                    Telefono: c.telefono,
                    Email: c.email,
                    Direccion: c.direccion,
                    Ingresos: c.ingresosMensuales,
                    Gastos: c.gastosMensuales
                }));
                utils.exportToExcel(data, 'Clientes_' + utils.getToday(), 'Clientes');
            }
        };

        // ==========================================
        // M√ìDULO CR√âDITOS
        // ==========================================
        const creditModule = {
            credits: {},
            clients: {},
            currentTab: 'active',
            editingId: null,
            simulationData: null,

            init: () => {
                creditModule.loadCredits();
                creditModule.loadClientsSelect();
                creditModule.populateDiaPagoSelect(); // Llenar el select de d√≠a de pago
                document.getElementById('creditFechaDesembolso').value = utils.getToday();
                
                // Cargar configuraci√≥n para valores por defecto
                database.ref('configuracion').once('value', (snapshot) => {
                    const config = snapshot.val() || {};
                    document.getElementById('creditTasa').value = config.tasaAnual || 16;
                    document.getElementById('creditComision').value = config.comisionApertura || 0;
                });
            },

            populateDiaPagoSelect: () => {
                const select = document.getElementById('creditDiaPago');
                select.innerHTML = '';
                for (let i = 1; i <= 30; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    select.appendChild(option);
                }
            },

            loadClientsSelect: () => {
                database.ref('clientes').once('value', (snapshot) => {
                    const select = document.getElementById('creditClientId');
                    select.innerHTML = '<option value="">Seleccione cliente...</option>';
                    
                    snapshot.forEach((child) => {
                        const client = child.val();
                        const capacidad = ((client.ingresosMensuales || 0) + (client.otrosIngresos || 0) - (client.gastosMensuales || 0)) * 0.4;
                        select.innerHTML += `<option value="${child.key}" data-capacidad="${capacidad}">${client.apellidos}, ${client.nombres} - ${client.numeroDocumento}</option>`;
                    });
                });
            },

            loadClientInfo: () => {
                const select = document.getElementById('creditClientId');
                const option = select.options[select.selectedIndex];
                const capacidad = option.getAttribute('data-capacidad') || 0;
                
                document.getElementById('creditClientCapacidad').value = utils.formatMoney(capacidad) + ' m√°ximo';
                
                const clientId = select.value;
                if (!clientId) {
                    document.getElementById('creditClientInfo').style.display = 'none';
                    return;
                }

                database.ref('clientes/' + clientId).once('value', (snapshot) => {
                    const client = snapshot.val();
                    if (client) {
                        document.getElementById('creditClientInfo').innerHTML = `
                            <strong>Cliente:</strong> ${client.nombres} ${client.apellidos}<br>
                            <strong>Tel√©fono:</strong> ${client.telefono}<br>
                            <strong>Direcci√≥n:</strong> ${client.direccion || 'No registrada'}<br>
                            <strong>Ingresos:</strong> ${utils.formatMoney(client.ingresosMensuales || 0)}
                        `;
                        document.getElementById('creditClientInfo').style.display = 'block';
                    }
                });
            },

            loadCredits: () => {
                utils.showLoading(true);
                Promise.all([
                    database.ref('creditos').once('value'),
                    database.ref('clientes').once('value')
                ]).then(([creditsSnap, clientsSnap]) => {
                    creditModule.credits = creditsSnap.val() || {};
                    creditModule.clients = clientsSnap.val() || {};
                    creditModule.renderCredits();
                    utils.showLoading(false);
                });
            },

            renderCredits: () => {
                const tbody = document.getElementById('creditsTable');
                tbody.innerHTML = '';

                const search = document.getElementById('creditSearch')?.value.toLowerCase() || '';
                const dateFrom = document.getElementById('creditDateFrom')?.value;
                const dateTo = document.getElementById('creditDateTo')?.value;

                Object.entries(creditModule.credits).forEach(([id, credit]) => {
                    // Filtro por tab
                    if (creditModule.currentTab === 'active' && credit.estado !== 'ACTIVO') return;
                    if (creditModule.currentTab === 'paid' && credit.estado !== 'CANCELADO') return;
                    if (creditModule.currentTab === 'default' && credit.diasMora === 0) return;

                    // Filtro por b√∫squeda
                    const client = creditModule.clients[credit.clienteId];
                    const clientName = client ? `${client.nombres} ${client.apellidos}`.toLowerCase() : '';
                    if (search && !clientName.includes(search) && !id.toLowerCase().includes(search)) return;

                    // Filtro por fecha
                    if (dateFrom && credit.fechaDesembolso < dateFrom) return;
                    if (dateTo && credit.fechaDesembolso > dateTo) return;

                    const proximoPago = credit.proximoPago || '-';
                    const diasMora = credit.diasMora || 0;
                    
                    const row = `
                        <tr>
                            <td>${id.substr(-6)}</td>
                            <td>${client ? client.apellidos + ', ' + client.nombres : 'N/A'}</td>
                            <td>${utils.formatMoney(credit.monto)}</td>
                            <td>${utils.formatMoney(credit.saldoActual)}</td>
                            <td>${utils.formatMoney(credit.cuotaMensual)}</td>
                            <td>${utils.formatDate(proximoPago)}</td>
                            <td>${diasMora > 0 ? '<span style="color: var(--danger); font-weight: bold;">' + diasMora + '</span>' : '0'}</td>
                            <td><span class="badge badge-${credit.estado === 'ACTIVO' ? 'success' : (credit.estado === 'CANCELADO' ? 'info' : 'danger')}">${credit.estado}</span></td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="creditModule.viewDetail('${id}')">Ver</button>
                                <button class="btn btn-sm btn-secondary" onclick="creditModule.edit('${id}')">Editar</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                if (tbody.innerHTML === '') {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">No hay cr√©ditos en esta categor√≠a</td></tr>';
                }
            },

            switchTab: (tab, element) => {
                creditModule.currentTab = tab;
                
                document.querySelectorAll('#module-credits .tab').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
                
                creditModule.renderCredits();
            },

            search: () => {
                creditModule.renderCredits();
            },

            filter: () => {
                creditModule.renderCredits();
            },

            switchCreditTab: (tab, element) => {
                document.querySelectorAll('#creditForm .tab').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('#creditForm .tab-content').forEach(el => el.classList.remove('active'));
                
                element.classList.add('active');
                document.getElementById('creditTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
                
                if (tab === 'simulation') {
                    creditModule.calculateSimulation();
                }
            },

            calculateSimulation: () => {
                const monto = parseFloat(document.getElementById('creditMonto').value) || 0;
                const plazo = parseInt(document.getElementById('creditPlazo').value) || 0;
                const tasaAnual = parseFloat(document.getElementById('creditTasa').value) || 0;
                const sistema = document.getElementById('creditSistema').value;
                const fechaDesembolso = document.getElementById('creditFechaDesembolso').value || utils.getToday();
                const diaPago = parseInt(document.getElementById('creditDiaPago').value) || 1;

                if (!monto || !plazo) {
                    document.getElementById('simulationTableBody').innerHTML = '<tr><td colspan="7" class="text-center">Ingrese monto y plazo para simular</td></tr>';
                    return;
                }

                // Si tasa es 0, calcular sin intereses
                const tasaMensual = tasaAnual > 0 ? (tasaAnual / 100) / 12 : 0;
                let tabla = [];
                let cuotaFija = 0;
                let totalInteres = 0;

                // Calcular fechas de pago
                const getFechaPago = (mes) => {
                    const fecha = new Date(fechaDesembolso);
                    fecha.setMonth(fecha.getMonth() + mes);
                    fecha.setDate(diaPago);
                    return fecha.toISOString().split('T')[0];
                };

                if (sistema === 'frances') {
                    // Sistema Franc√©s
                    if (tasaMensual === 0) {
                        // Sin intereses: cuota = capital / plazo
                        cuotaFija = monto / plazo;
                        let saldo = monto;
                        
                        for (let i = 1; i <= plazo; i++) {
                            saldo -= cuotaFija;
                            tabla.push({
                                cuota: i,
                                fecha: getFechaPago(i),
                                cuotaTotal: cuotaFija,
                                capital: cuotaFija,
                                interes: 0,
                                seguro: 0,
                                saldo: saldo > 0 ? saldo : 0
                            });
                        }
                    } else {
                        cuotaFija = (monto * tasaMensual) / (1 - Math.pow(1 + tasaMensual, -plazo));
                        let saldo = monto;
                        
                        for (let i = 1; i <= plazo; i++) {
                            const interes = saldo * tasaMensual;
                            const capital = cuotaFija - interes;
                            saldo -= capital;
                            totalInteres += interes;
                            
                            tabla.push({
                                cuota: i,
                                fecha: getFechaPago(i),
                                cuotaTotal: cuotaFija,
                                capital: capital,
                                interes: interes,
                                seguro: 0,
                                saldo: saldo > 0 ? saldo : 0
                            });
                        }
                    }
                } else if (sistema === 'aleman') {
                    // Sistema Alem√°n
                    const amortizacion = monto / plazo;
                    let saldo = monto;
                    
                    for (let i = 1; i <= plazo; i++) {
                        const interes = saldo * tasaMensual;
                        const cuota = amortizacion + interes;
                        saldo -= amortizacion;
                        totalInteres += interes;
                        
                        tabla.push({
                            cuota: i,
                            fecha: getFechaPago(i),
                            cuotaTotal: cuota,
                            capital: amortizacion,
                            interes: interes,
                            seguro: 0,
                            saldo: saldo > 0 ? saldo : 0
                        });
                    }
                    cuotaFija = tabla[0].cuotaTotal;
                } else if (sistema === 'americano') {
                    // Sistema Americano
                    const interesMensual = monto * tasaMensual;
                    
                    for (let i = 1; i <= plazo; i++) {
                        const esUltima = i === plazo;
                        const capital = esUltima ? monto : 0;
                        const cuota = interesMensual + capital;
                        
                        tabla.push({
                            cuota: i,
                            fecha: getFechaPago(i),
                            cuotaTotal: cuota,
                            capital: capital,
                            interes: interesMensual,
                            seguro: 0,
                            saldo: esUltima ? 0 : monto
                        });
                        
                        if (esUltima) totalInteres = interesMensual * plazo;
                    }
                    cuotaFija = interesMensual;
                }

                // Mostrar resumen
                const totalPagar = tabla.reduce((sum, t) => sum + t.cuotaTotal, 0);
                const tcea = tasaAnual > 0 ? (Math.pow(1 + tasaMensual, 12) - 1) * 100 : 0;

                document.getElementById('simCuota').textContent = utils.formatMoney(cuotaFija);
                document.getElementById('simTotalInteres').textContent = utils.formatMoney(totalInteres);
                document.getElementById('simTotalPagar').textContent = utils.formatMoney(totalPagar);
                document.getElementById('simTCEA').textContent = tcea.toFixed(2) + '%';

                // Mostrar tabla
                const tbody = document.getElementById('simulationTableBody');
                tbody.innerHTML = '';
                
                tabla.forEach(fila => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${fila.cuota}</td>
                            <td>${utils.formatDate(fila.fecha)}</td>
                            <td>${utils.formatMoney(fila.cuotaTotal)}</td>
                            <td>${utils.formatMoney(fila.capital)}</td>
                            <td>${utils.formatMoney(fila.interes)}</td>
                            <td>${utils.formatMoney(fila.seguro)}</td>
                            <td>${utils.formatMoney(fila.saldo)}</td>
                        </tr>
                    `;
                });

                creditModule.simulationData = tabla;
            },

            showCreateModal: () => {
                creditModule.editingId = null;
                document.getElementById('creditModalTitle').textContent = 'Nuevo Cr√©dito';
                document.getElementById('creditForm').reset();
                document.getElementById('creditId').value = '';
                document.getElementById('creditEditMode').value = 'false';
                document.getElementById('creditFechaDesembolso').value = utils.getToday();
                document.getElementById('creditClientInfo').style.display = 'none';
                document.getElementById('simulationTableBody').innerHTML = '<tr><td colspan="7" class="text-center">Ingrese datos para simular</td></tr>';
                document.getElementById('creditSubmitBtn').textContent = 'Desembolsar Cr√©dito';
                document.getElementById('creditClientId').disabled = false;
                
                // Asegurar que el select de d√≠a de pago est√© poblado
                creditModule.populateDiaPagoSelect();
                
                // Cargar valores por defecto
                database.ref('configuracion').once('value', (snapshot) => {
                    const config = snapshot.val() || {};
                    document.getElementById('creditTasa').value = config.tasaAnual || 16;
                });
                
                document.getElementById('modalCredit').classList.add('active');
                creditModule.loadClientsSelect();
            },

            edit: (id) => {
                const credit = creditModule.credits[id];
                if (!credit) return;

                // Verificar si tiene pagos realizados
                if (credit.pagosRealizados > 0) {
                    if (!confirm('Este cr√©dito tiene pagos realizados. Solo puede editar ciertos campos (observaciones, fechas, tasa si no afecta pagos anteriores). ¬øDesea continuar?')) {
                        return;
                    }
                }

                creditModule.editingId = id;
                document.getElementById('creditModalTitle').textContent = 'Editar Cr√©dito';
                document.getElementById('creditId').value = id;
                document.getElementById('creditEditMode').value = 'true';
                document.getElementById('creditSubmitBtn').textContent = 'Guardar Cambios';
                
                // Asegurar que el select de d√≠a de pago est√© poblado
                creditModule.populateDiaPagoSelect();
                
                // Cargar datos
                document.getElementById('creditClientId').value = credit.clienteId;
                document.getElementById('creditClientId').disabled = true; // No cambiar cliente
                creditModule.loadClientInfo();
                
                document.getElementById('creditMonto').value = credit.monto;
                document.getElementById('creditPlazo').value = credit.plazo;
                document.getElementById('creditTasa').value = credit.tasaAnual;
                document.getElementById('creditSistema').value = credit.sistema;
                document.getElementById('creditFechaDesembolso').value = credit.fechaDesembolso;
                document.getElementById('creditDiaPago').value = credit.diaPago || 1;
                document.getElementById('creditDestino').value = credit.destino || 'CONSUMO';
                document.getElementById('creditComision').value = credit.comisionApertura || 0;
                document.getElementById('creditSeguro').value = credit.seguroDesgravamen || 0;

                // Recalcular simulaci√≥n
                creditModule.calculateSimulation();
                
                document.getElementById('modalCredit').classList.add('active');
            },

            closeModal: () => {
                document.getElementById('modalCredit').classList.remove('active');
            },

            save: (e) => {
                e.preventDefault();
                
                const isEdit = document.getElementById('creditEditMode').value === 'true';
                
                if (!isEdit && (!creditModule.simulationData || creditModule.simulationData.length === 0)) {
                    utils.showToast('Primero debe calcular la simulaci√≥n', 'error');
                    return;
                }

                utils.showLoading(true);

                const clientId = document.getElementById('creditClientId').value;
                const monto = parseFloat(document.getElementById('creditMonto').value) || 0;
                const plazo = parseInt(document.getElementById('creditPlazo').value) || 0;
                const tasa = parseFloat(document.getElementById('creditTasa').value) || 0;
                const sistema = document.getElementById('creditSistema').value;
                const fechaDesembolso = document.getElementById('creditFechaDesembolso').value;

                if (isEdit) {
                    // Modo edici√≥n - solo ciertos campos
                    const creditId = creditModule.editingId;
                    const existingCredit = creditModule.credits[creditId];
                    
                    const updates = {
                        tasaAnual: tasa,
                        sistema: sistema,
                        destino: document.getElementById('creditDestino').value,
                        diaPago: parseInt(document.getElementById('creditDiaPago').value) || 1,
                        seguroDesgravamen: parseFloat(document.getElementById('creditSeguro').value) || 0,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedBy: currentUser.uid
                    };

                    // Si no tiene pagos, permitir recalcular tabla
                    if (existingCredit.pagosRealizados === 0) {
                        // Recalcular simulaci√≥n con los nuevos valores
                        creditModule.calculateSimulation();
                        if (creditModule.simulationData && creditModule.simulationData.length > 0) {
                            updates.cuotaMensual = creditModule.simulationData[0].cuotaTotal;
                            updates.tablaAmortizacion = creditModule.simulationData;
                            updates.interesPendiente = creditModule.simulationData.reduce((sum, t) => sum + t.interes, 0);
                            // Actualizar pr√≥ximo pago
                            const nextCuota = creditModule.simulationData.find(c => c.cuota === 1);
                            if (nextCuota) updates.proximoPago = nextCuota.fecha;
                        }
                    }

                    database.ref('creditos/' + creditId).update(updates)
                        .then(() => {
                            auditModule.log('update', 'credito', creditId, `Edici√≥n de cr√©dito - Tasa: ${tasa}%, Sistema: ${sistema}`);
                            utils.showLoading(false);
                            utils.showToast('Cr√©dito actualizado exitosamente');
                            creditModule.closeModal();
                            creditModule.loadCredits();
                        })
                        .catch((error) => {
                            utils.showLoading(false);
                            utils.showToast('Error: ' + error.message, 'error');
                        });
                } else {
                    // Modo creaci√≥n
                    const creditData = {
                        clienteId: clientId,
                        monto: monto,
                        plazo: plazo,
                        tasaAnual: tasa,
                        sistema: sistema,
                        destino: document.getElementById('creditDestino').value,
                        fechaDesembolso: fechaDesembolso,
                        diaPago: parseInt(document.getElementById('creditDiaPago').value) || 1,
                        cuotaMensual: creditModule.simulationData[0].cuotaTotal,
                        saldoActual: monto,
                        capitalPendiente: monto,
                        interesPendiente: creditModule.simulationData.reduce((sum, t) => sum + t.interes, 0),
                        estado: 'ACTIVO',
                        proximoPago: creditModule.simulationData[0].fecha,
                        diasMora: 0,
                        tablaAmortizacion: creditModule.simulationData,
                        pagosRealizados: 0,
                        totalPagado: 0,
                        comisionApertura: parseFloat(document.getElementById('creditComision').value) || 0,
                        seguroDesgravamen: parseFloat(document.getElementById('creditSeguro').value) || 0,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        createdBy: currentUser.uid,
                        createdByName: currentUserData?.nombre || 'Admin'
                    };

                    const creditId = utils.generateId();

                    database.ref('creditos/' + creditId).set(creditData)
                        .then(() => {
                            // Crear asiento contable
                            return accountingModule.createAsiento({
                                fecha: fechaDesembolso,
                                tipo: 'DESEMBOLSO',
                                descripcion: `Desembolso cr√©dito ${creditId.substr(-6)}`,
                                monto: monto,
                                asientos: [
                                    { cuenta: '1.1.2.01', nombre: 'Cartera de Cr√©ditos', debe: monto, haber: 0 },
                                    { cuenta: '1.1.1.01', nombre: 'Caja/Bancos', debe: 0, haber: monto }
                                ],
                                referencia: creditId
                            });
                        })
                        .then(() => {
                            auditModule.log('create', 'credito', creditId, `Desembolso: ${utils.formatMoney(monto)} a ${creditModule.clients[clientId]?.apellidos || 'Cliente'}`);
                            
                            utils.showLoading(false);
                            utils.showToast('Cr√©dito desembolsado exitosamente');
                            creditModule.closeModal();
                            creditModule.loadCredits();
                            dashboardModule.refresh();
                        })
                        .catch((error) => {
                            utils.showLoading(false);
                            utils.showToast('Error: ' + error.message, 'error');
                        });
                }
            },

            viewDetail: (id) => {
                const credit = creditModule.credits[id];
                if (!credit) return;

                const client = creditModule.clients[credit.clienteId];
                const content = document.getElementById('creditDetailContent');
                
                let tablaHtml = '';
                if (credit.tablaAmortizacion) {
                    tablaHtml = `
                        <div class="data-table-container" style="margin-top: 16px; max-height: 300px; overflow-y: auto;">
                            <table class="data-table amortization-table">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Fecha</th>
                                        <th>Cuota</th>
                                        <th>Capital</th>
                                        <th>Inter√©s</th>
                                        <th>Saldo</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${credit.tablaAmortizacion.map((fila, idx) => {
                                        const pagada = idx < credit.pagosRealizados;
                                        return `
                                            <tr style="${pagada ? 'background: #f0fdf4;' : ''}">
                                                <td>${fila.cuota}</td>
                                                <td>${utils.formatDate(fila.fecha)}</td>
                                                <td>${utils.formatMoney(fila.cuotaTotal)}</td>
                                                <td>${utils.formatMoney(fila.capital)}</td>
                                                <td>${utils.formatMoney(fila.interes)}</td>
                                                <td>${utils.formatMoney(fila.saldo)}</td>
                                                <td>${pagada ? '<span class="badge badge-success">Pagada</span>' : '<span class="badge badge-warning">Pendiente</span>'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div class="detail-view">
                        <div class="detail-row">
                            <div class="detail-label">No. Cr√©dito:</div>
                            <div>${id}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Cliente:</div>
                            <div>${client ? client.apellidos + ', ' + client.nombres : 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Monto Original:</div>
                            <div>${utils.formatMoney(credit.monto)}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Saldo Actual:</div>
                            <div style="font-size: 16px; font-weight: bold; color: var(--primary-blue);">${utils.formatMoney(credit.saldoActual)}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Cuota Mensual:</div>
                            <div>${utils.formatMoney(credit.cuotaMensual)}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Tasa Anual:</div>
                            <div>${credit.tasaAnual}% ${credit.tasaAnual === 0 ? '(Sin intereses)' : ''}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Plazo:</div>
                            <div>${credit.plazo} meses (${credit.pagosRealizados} pagados)</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Pr√≥ximo Pago:</div>
                            <div>${utils.formatDate(credit.proximoPago)}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">D√≠as de Mora:</div>
                            <div style="color: ${credit.diasMora > 0 ? 'var(--danger)' : 'inherit'}; font-weight: ${credit.diasMora > 0 ? 'bold' : 'normal'};">${credit.diasMora || 0}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Estado:</div>
                            <div><span class="badge badge-${credit.estado === 'ACTIVO' ? 'success' : (credit.estado === 'CANCELADO' ? 'info' : 'danger')}">${credit.estado}</span></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Fecha Desembolso:</div>
                            <div>${utils.formatDate(credit.fechaDesembolso)}</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 24px; margin-bottom: 12px; color: var(--primary-blue);">Tabla de Amortizaci√≥n</h4>
                    ${tablaHtml}
                `;
                
                document.getElementById('modalCreditDetail').classList.add('active');
            },

            closeDetailModal: () => {
                document.getElementById('modalCreditDetail').classList.remove('active');
            },

            printDetail: () => {
                window.print();
            },

            exportToExcel: () => {
                const data = Object.entries(creditModule.credits).map(([id, c]) => ({
                    ID: id,
                    Cliente: creditModule.clients[c.clienteId]?.apellidos + ', ' + creditModule.clients[c.clienteId]?.nombres || 'N/A',
                    Monto: c.monto,
                    Saldo: c.saldoActual,
                    Cuota: c.cuotaMensual,
                    Plazo: c.plazo,
                    Tasa: c.tasaAnual,
                    Estado: c.estado,
                    Fecha_Desembolso: c.fechaDesembolso
                }));
                utils.exportToExcel(data, 'Creditos_' + utils.getToday(), 'Creditos');
            }
        };

        // ==========================================
        // M√ìDULO PAGOS (COMPLETO)
        // ==========================================
        const paymentModule = {
            payments: {},
            credits: {},
            clients: {},
            editingId: null,

            init: () => {
                paymentModule.loadPayments();
                paymentModule.loadCreditsSelect();
                document.getElementById('paymentFecha').value = utils.getToday();
            },

            loadCreditsSelect: () => {
                database.ref('creditos').orderByChild('estado').equalTo('ACTIVO').once('value', (snapshot) => {
                    const select = document.getElementById('paymentCreditId');
                    select.innerHTML = '<option value="">Seleccione cr√©dito...</option>';
                    
                    snapshot.forEach((child) => {
                        const credit = child.val();
                        database.ref('clientes/' + credit.clienteId).once('value', (clientSnap) => {
                            const client = clientSnap.val();
                            const option = document.createElement('option');
                            option.value = child.key;
                            option.textContent = `${client?.apellidos || 'N/A'}, ${client?.nombres || ''} - Saldo: ${utils.formatMoney(credit.saldoActual)}`;
                            option.setAttribute('data-saldo', credit.saldoActual);
                            option.setAttribute('data-cuota', credit.cuotaMensual);
                            option.setAttribute('data-proximo', credit.proximoPago || '');
                            option.setAttribute('data-cliente', credit.clienteId);
                            option.setAttribute('data-cliente-nombre', `${client?.nombres || ''} ${client?.apellidos || ''}`);
                            select.appendChild(option);
                        });
                    });
                });
            },

            loadPayments: () => {
                utils.showLoading(true);
                Promise.all([
                    database.ref('pagos').limitToLast(100).once('value'),
                    database.ref('creditos').once('value'),
                    database.ref('clientes').once('value')
                ]).then(([paymentsSnap, creditsSnap, clientsSnap]) => {
                    paymentModule.payments = paymentsSnap.val() || {};
                    paymentModule.credits = creditsSnap.val() || {};
                    paymentModule.clients = clientsSnap.val() || {};
                    paymentModule.renderPayments();
                    utils.showLoading(false);
                });
            },

            renderPayments: () => {
                const tbody = document.getElementById('paymentsTable');
                tbody.innerHTML = '';

                const search = document.getElementById('paymentSearchCredit')?.value.toLowerCase() || '';
                const dateFrom = document.getElementById('paymentDateFrom')?.value;
                const dateTo = document.getElementById('paymentDateTo')?.value;

                const payments = Object.entries(paymentModule.payments);
                payments.reverse(); // M√°s recientes primero

                payments.forEach(([id, payment]) => {
                    const credit = paymentModule.credits[payment.creditoId];
                    
                    // Filtros
                    if (search && !payment.creditoId?.toLowerCase().includes(search)) return;
                    if (dateFrom && payment.fecha < dateFrom) return;
                    if (dateTo && payment.fecha > dateTo) return;

                    const row = `
                        <tr>
                            <td>${id.substr(-6)}</td>
                            <td>${utils.formatDate(payment.fecha)}<br><small>${utils.formatDateTime(payment.timestamp)}</small></td>
                            <td>${payment.creditoId?.substr(-6) || '-'}</td>
                            <td>${payment.clienteNombre || 'N/A'}</td>
                            <td><span class="badge badge-info">${payment.tipo}</span></td>
                            <td>${utils.formatMoney(payment.capital || 0)}</td>
                            <td>${utils.formatMoney(payment.interes || 0)}</td>
                            <td style="font-weight: bold;">${utils.formatMoney(payment.monto)}</td>
                            <td>${payment.usuarioNombre || 'Admin'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="paymentModule.edit('${id}')">Editar</button>
                                <button class="btn btn-sm btn-danger" onclick="paymentModule.delete('${id}')">Anular</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                if (tbody.innerHTML === '') {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center">No se encontraron pagos</td></tr>';
                }
            },

            search: () => {
                paymentModule.renderPayments();
            },

            filter: () => {
                paymentModule.renderPayments();
            },

            clearFilters: () => {
                document.getElementById('paymentSearchCredit').value = '';
                document.getElementById('paymentDateFrom').value = '';
                document.getElementById('paymentDateTo').value = '';
                paymentModule.renderPayments();
            },

            showModal: () => {
                document.getElementById('paymentForm').reset();
                document.getElementById('paymentCreditInfo').style.display = 'none';
                document.getElementById('paymentFecha').value = utils.getToday();
                document.getElementById('modalPayment').classList.add('active');
                paymentModule.loadCreditsSelect();
            },

            closeModal: () => {
                document.getElementById('modalPayment').classList.remove('active');
            },

            loadCreditDetails: () => {
                const select = document.getElementById('paymentCreditId');
                const option = select.options[select.selectedIndex];
                
                if (!option.value) {
                    document.getElementById('paymentCreditInfo').style.display = 'none';
                    return;
                }

                const saldo = parseFloat(option.getAttribute('data-saldo') || 0);
                const cuota = parseFloat(option.getAttribute('data-cuota') || 0);
                const proximo = option.getAttribute('data-proximo') || '';
                const clienteNombre = option.getAttribute('data-cliente-nombre') || '';

                document.getElementById('payInfoCliente').textContent = clienteNombre;
                document.getElementById('payInfoSaldo').textContent = utils.formatMoney(saldo);
                document.getElementById('payInfoCuota').textContent = utils.formatMoney(cuota);
                document.getElementById('payInfoProximo').textContent = utils.formatDate(proximo);
                
                document.getElementById('paymentCreditInfo').style.display = 'block';
                
                // Sugerir monto
                document.getElementById('paymentMonto').value = cuota.toFixed(2);
            },

            updateAmount: () => {
                const tipo = document.getElementById('paymentTipo').value;
                const select = document.getElementById('paymentCreditId');
                const option = select.options[select.selectedIndex];
                
                if (!option.value) return;

                const saldo = parseFloat(option.getAttribute('data-saldo') || 0);
                const cuota = parseFloat(option.getAttribute('data-cuota') || 0);

                if (tipo === 'TOTAL') {
                    document.getElementById('paymentMonto').value = saldo.toFixed(2);
                } else if (tipo === 'CUOTA') {
                    document.getElementById('paymentMonto').value = cuota.toFixed(2);
                }
            },

            process: (e) => {
                e.preventDefault();
                utils.showLoading(true);

                const creditId = document.getElementById('paymentCreditId').value;
                const tipo = document.getElementById('paymentTipo').value;
                const monto = parseFloat(document.getElementById('paymentMonto').value) || 0;
                const fecha = document.getElementById('paymentFecha').value;

                if (!creditId || !monto) {
                    utils.showLoading(false);
                    utils.showToast('Complete todos los campos requeridos', 'error');
                    return;
                }

                const credit = paymentModule.credits[creditId];
                const clientId = credit.clienteId;
                const client = paymentModule.clients[clientId];

                // Calcular distribuci√≥n
                let capital = 0;
                let interes = 0;
                let mora = 0;

                if (tipo === 'CUOTA') {
                    // Si la tasa es 0, todo va a capital
                    if (credit.tasaAnual === 0) {
                        capital = monto;
                        interes = 0;
                    } else {
                        const tasaMensual = (credit.tasaAnual / 100) / 12;
                        interes = credit.saldoActual * tasaMensual;
                        capital = monto - interes;
                        if (capital < 0) capital = 0;
                    }
                } else if (tipo === 'CAPITAL') {
                    capital = monto;
                } else if (tipo === 'INTERES') {
                    interes = monto;
                } else if (tipo === 'TOTAL') {
                    capital = credit.saldoActual;
                } else if (tipo === 'MORA') {
                    mora = monto;
                }

                const nuevoSaldo = credit.saldoActual - capital;
                const estado = nuevoSaldo <= 0 ? 'CANCELADO' : 'ACTIVO';
                
                // Calcular pr√≥ximo pago
                let proximoPago = credit.proximoPago;
                if (estado === 'ACTIVO' && credit.tablaAmortizacion) {
                    const nextCuota = credit.tablaAmortizacion.find(c => c.cuota > credit.pagosRealizados);
                    if (nextCuota) {
                        proximoPago = nextCuota.fecha;
                    }
                }

                // Calcular d√≠as de mora actualizados
                const diasMora = utils.calculateDueDays(proximoPago);

                const paymentId = utils.generateId();
                const paymentData = {
                    creditoId: creditId,
                    clienteId: clientId,
                    clienteNombre: client ? `${client.nombres} ${client.apellidos}` : 'N/A',
                    tipo: tipo,
                    monto: monto,
                    capital: capital,
                    interes: interes,
                    mora: mora,
                    fecha: fecha,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    metodo: document.getElementById('paymentMetodo').value,
                    referencia: document.getElementById('paymentReferencia').value,
                    observaciones: document.getElementById('paymentObservaciones').value,
                    usuarioId: currentUser.uid,
                    usuarioNombre: currentUserData?.nombre || 'Admin'
                };

                const updates = {
                    ['pagos/' + paymentId]: paymentData,
                    ['creditos/' + creditId + '/saldoActual']: nuevoSaldo > 0 ? nuevoSaldo : 0,
                    ['creditos/' + creditId + '/capitalPendiente']: nuevoSaldo > 0 ? nuevoSaldo : 0,
                    ['creditos/' + creditId + '/estado']: estado,
                    ['creditos/' + creditId + '/pagosRealizados']: (credit.pagosRealizados || 0) + 1,
                    ['creditos/' + creditId + '/totalPagado']: (credit.totalPagado || 0) + monto,
                    ['creditos/' + creditId + '/proximoPago']: proximoPago,
                    ['creditos/' + creditId + '/diasMora']: diasMora,
                    ['creditos/' + creditId + '/ultimoPago']: fecha
                };

                if (estado === 'CANCELADO') {
                    updates['creditos/' + creditId + '/fechaCancelacion'] = fecha;
                }

                database.ref().update(updates)
                    .then(() => {
                        // Asiento contable
                        const asientoDebe = [];
                        const asientoHaber = [];
                        
                        if (capital > 0) {
                            asientoDebe.push({ cuenta: '1.1.1.01', nombre: 'Caja/Bancos', monto: capital });
                            asientoHaber.push({ cuenta: '1.1.2.01', nombre: 'Cartera de Cr√©ditos', monto: capital });
                        }
                        if (interes > 0) {
                            asientoDebe.push({ cuenta: '1.1.1.01', nombre: 'Caja/Bancos', monto: interes });
                            asientoHaber.push({ cuenta: '4.1.1.01', nombre: 'Intereses Ganados - Cartera', monto: interes });
                        }
                        if (mora > 0) {
                            asientoDebe.push({ cuenta: '1.1.1.01', nombre: 'Caja/Bancos', monto: mora });
                            asientoHaber.push({ cuenta: '4.1.1.03', nombre: 'Intereses por Mora', monto: mora });
                        }

                        return accountingModule.createAsiento({
                            fecha: fecha,
                            tipo: 'PAGO',
                            descripcion: `Pago ${tipo} - Cr√©dito ${creditId.substr(-6)} - ${client?.apellidos || 'Cliente'}`,
                            monto: monto,
                            asientos: [
                                ...asientoDebe.map(a => ({ cuenta: a.cuenta, nombre: a.nombre, debe: a.monto, haber: 0 })),
                                ...asientoHaber.map(a => ({ cuenta: a.cuenta, nombre: a.nombre, debe: 0, haber: a.monto }))
                            ],
                            referencia: paymentId
                        });
                    })
                    .then(() => {
                        auditModule.log('payment', 'pago', paymentId, `Pago ${tipo}: ${utils.formatMoney(monto)} - Cliente: ${paymentData.clienteNombre}`);
                        
                        utils.showLoading(false);
                        utils.showToast('Pago procesado exitosamente');
                        paymentModule.closeModal();
                        paymentModule.loadPayments();
                        dashboardModule.refresh();
                    })
                    .catch((error) => {
                        utils.showLoading(false);
                        utils.showToast('Error: ' + error.message, 'error');
                    });
            },

            edit: (id) => {
                const payment = paymentModule.payments[id];
                if (!payment) return;

                document.getElementById('editPaymentId').value = id;
                document.getElementById('editPaymentMonto').value = payment.monto;
                document.getElementById('editPaymentFecha').value = payment.fecha;
                document.getElementById('editPaymentObs').value = payment.observaciones || '';
                
                document.getElementById('modalEditPayment').classList.add('active');
            },

            closeEditModal: () => {
                document.getElementById('modalEditPayment').classList.remove('active');
            },

            saveEdit: (e) => {
                e.preventDefault();
                utils.showLoading(true);

                const id = document.getElementById('editPaymentId').value;
                const updates = {
                    monto: parseFloat(document.getElementById('editPaymentMonto').value) || 0,
                    fecha: document.getElementById('editPaymentFecha').value,
                    observaciones: document.getElementById('editPaymentObs').value,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: currentUser.uid
                };

                database.ref('pagos/' + id).update(updates)
                    .then(() => {
                        auditModule.log('update', 'pago', id, 'Edici√≥n de pago');
                        utils.showLoading(false);
                        utils.showToast('Pago actualizado');
                        paymentModule.closeEditModal();
                        paymentModule.loadPayments();
                    })
                    .catch((error) => {
                        utils.showLoading(false);
                        utils.showToast('Error: ' + error.message, 'error');
                    });
            },

            delete: (id) => {
                if (!confirm('¬øEst√° seguro de anular este pago? Esta acci√≥n no se puede deshacer.')) return;
                
                utils.showLoading(true);
                
                const payment = paymentModule.payments[id];
                if (!payment) {
                    utils.showLoading(false);
                    return;
                }

                // Revertir el pago en el cr√©dito
                const creditId = payment.creditoId;
                const credit = paymentModule.credits[creditId];
                
                if (!credit) {
                    utils.showToast('No se encontr√≥ el cr√©dito asociado', 'error');
                    utils.showLoading(false);
                    return;
                }

                // Calcular nuevo saldo (revertir)
                const nuevoSaldo = credit.saldoActual + (payment.capital || 0);
                const nuevoTotalPagado = (credit.totalPagado || 0) - payment.monto;
                const nuevosPagosRealizados = Math.max(0, (credit.pagosRealizados || 0) - 1);
                
                // Determinar nuevo estado
                let nuevoEstado = 'ACTIVO';
                if (nuevoSaldo <= 0) nuevoEstado = 'CANCELADO';
                if (nuevoSaldo >= credit.monto) nuevoEstado = 'ACTIVO';

                const updates = {
                    ['pagos/' + id + '/estado']: 'ANULADO',
                    ['pagos/' + id + '/anuladoAt']: firebase.database.ServerValue.TIMESTAMP,
                    ['pagos/' + id + '/anuladoBy']: currentUser.uid,
                    ['creditos/' + creditId + '/saldoActual']: nuevoSaldo,
                    ['creditos/' + creditId + '/capitalPendiente']: nuevoSaldo,
                    ['creditos/' + creditId + '/estado']: nuevoEstado,
                    ['creditos/' + creditId + '/pagosRealizados']: nuevosPagosRealizados,
                    ['creditos/' + creditId + '/totalPagado']: nuevoTotalPagado
                };

                database.ref().update(updates)
                    .then(() => {
                        // Crear asiento contable de reversi√≥n
                        const asientoDebe = [];
                        const asientoHaber = [];
                        
                        if (payment.capital > 0) {
                            asientoDebe.push({ cuenta: '1.1.2.01', nombre: 'Cartera de Cr√©ditos', monto: payment.capital });
                            asientoHaber.push({ cuenta: '1.1.1.01', nombre: 'Caja/Bancos', monto: payment.capital });
                        }
                        if (payment.interes > 0) {
                            asientoDebe.push({ cuenta: '4.1.1.01', nombre: 'Intereses Ganados - Cartera', monto: payment.interes });
                            asientoHaber.push({ cuenta: '1.1.1.01', nombre: 'Caja/Bancos', monto: payment.interes });
                        }

                        return accountingModule.createAsiento({
                            fecha: utils.getToday(),
                            tipo: 'ANULACION',
                            descripcion: `Anulaci√≥n pago ${id.substr(-6)} - Cr√©dito ${creditId.substr(-6)}`,
                            monto: payment.monto,
                            asientos: [
                                ...asientoDebe.map(a => ({ cuenta: a.cuenta, nombre: a.nombre, debe: a.monto, haber: 0 })),
                                ...asientoHaber.map(a => ({ cuenta: a.cuenta, nombre: a.nombre, debe: 0, haber: a.monto }))
                            ],
                            referencia: id
                        });
                    })
                    .then(() => {
                        auditModule.log('delete', 'pago', id, `Anulaci√≥n de pago por ${utils.formatMoney(payment.monto)}`);
                        utils.showLoading(false);
                        utils.showToast('Pago anulado y revertido');
                        paymentModule.loadPayments();
                        dashboardModule.refresh();
                    })
                    .catch((error) => {
                        utils.showLoading(false);
                        utils.showToast('Error: ' + error.message, 'error');
                    });
            },

            exportToExcel: () => {
                const data = Object.entries(paymentModule.payments).map(([id, p]) => ({
                    ID: id,
                    Fecha: p.fecha,
                    Credito: p.creditoId,
                    Cliente: p.clienteNombre,
                    Tipo: p.tipo,
                    Capital: p.capital,
                    Interes: p.interes,
                    Mora: p.mora,
                    Total: p.monto,
                    Metodo: p.metodo,
                    Usuario: p.usuarioNombre,
                    Estado: p.estado || 'ACTIVO'
                }));
                utils.exportToExcel(data, 'Pagos_' + utils.getToday(), 'Pagos');
            }
        };

        // ==========================================
        // M√ìDULO CONTABILIDAD COMPLETO
        // ==========================================
        const accountingModule = {
            asientos: [],
            currentTab: 'diario',
            saldosCuentas: {},

            init: () => {
                accountingModule.loadPlanCuentas();
                accountingModule.loadDiario();
            },

            switchTab: (tab, element) => {
                accountingModule.currentTab = tab;
                
                document.querySelectorAll('#module-accounting .tab').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('#module-accounting .tab-content').forEach(el => el.classList.remove('active'));
                
                element.classList.add('active');
                document.getElementById('accounting-' + tab).classList.add('active');

                accountingModule.loadCurrentTab();
            },

            loadCurrentTab: () => {
                if (accountingModule.currentTab === 'diario') accountingModule.loadDiario();
                if (accountingModule.currentTab === 'mayor') accountingModule.loadMayor();
                if (accountingModule.currentTab === 'balance') accountingModule.generateBalance();
                if (accountingModule.currentTab === 'resultados') accountingModule.generateResultados();
            },

            createAsiento: (data) => {
                const asientoId = utils.generateId();
                const asientoData = {
                    ...data,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: currentUser.uid,
                    createdByName: currentUserData?.nombre || 'Admin'
                };
                
                // Actualizar saldos en tiempo real
                data.asientos.forEach(asi => {
                    if (!accountingModule.saldosCuentas[asi.cuenta]) {
                        accountingModule.saldosCuentas[asi.cuenta] = { debe: 0, haber: 0 };
                    }
                    accountingModule.saldosCuentas[asi.cuenta].debe += asi.debe || 0;
                    accountingModule.saldosCuentas[asi.cuenta].haber += asi.haber || 0;
                });

                return database.ref('contabilidad/diario/' + asientoId).set(asientoData);
            },

            loadPlanCuentas: () => {
                const select = document.getElementById('mayorAccountSelect');
                const tbody = document.getElementById('planCuentasBody');
                
                select.innerHTML = '<option value="">Todas las cuentas</option>';
                tbody.innerHTML = '';

                planCuentasCompleto.forEach(cuenta => {
                    // Solo agregar cuentas de nivel 4 y 5 al selector de mayor
                    if (cuenta.nivel >= 4) {
                        select.innerHTML += `<option value="${cuenta.codigo}">${cuenta.codigo} - ${cuenta.nombre}</option>`;
                    }

                    // Determinar clase CSS seg√∫n nivel
                    const nivelClass = `cuenta-nivel-${cuenta.nivel}`;
                    const paddingLeft = cuenta.nivel > 3 ? `${(cuenta.nivel - 3) * 20}px` : '0';
                    
                    tbody.innerHTML += `
                        <tr class="${nivelClass}">
                            <td style="padding-left: ${paddingLeft}; font-weight: ${cuenta.nivel <= 3 ? 'bold' : 'normal'};">${cuenta.codigo}</td>
                            <td style="padding-left: ${paddingLeft};">${cuenta.nombre}</td>
                            <td>${cuenta.tipo}</td>
                            <td>${cuenta.naturaleza}</td>
                            <td class="text-right" id="saldo-${cuenta.codigo.replace(/\./g, '-')}">$0.00</td>
                            <td>
                                ${cuenta.nivel >= 4 ? `<button class="btn btn-sm btn-secondary" onclick="accountingModule.verMayor('${cuenta.codigo}')">Ver Mayor</button>` : ''}
                            </td>
                        </tr>
                    `;
                });
            },

            // Nueva funci√≥n para ver mayor de una cuenta espec√≠fica
            verMayor: (cuentaCodigo) => {
                // Cambiar a la pesta√±a de Mayor y seleccionar la cuenta
                const mayorTab = document.querySelector('[onclick="accountingModule.switchTab(\'mayor\', this)"]');
                if (mayorTab) accountingModule.switchTab('mayor', mayorTab);
                
                document.getElementById('mayorAccountSelect').value = cuentaCodigo;
                accountingModule.loadMayor();
            },

            loadDiario: () => {
                const dateFrom = document.getElementById('accountingDateFrom')?.value;
                const dateTo = document.getElementById('accountingDateTo')?.value;

                let query = database.ref('contabilidad/diario').limitToLast(100);
                
                query.once('value', (snapshot) => {
                    const container = document.getElementById('diarioContainer');
                    container.innerHTML = '';

                    const asientos = [];
                    snapshot.forEach((child) => {
                        asientos.push({ id: child.key, ...child.val() });
                    });
                    asientos.reverse();

                    // Filtros de fecha
                    const filtered = asientos.filter(a => {
                        if (dateFrom && a.fecha < dateFrom) return false;
                        if (dateTo && a.fecha > dateTo) return false;
                        return true;
                    });

                    if (filtered.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">No hay movimientos en el per√≠odo seleccionado</div>';
                        return;
                    }

                    filtered.forEach(asiento => {
                        let asientosHtml = '';
                        let totalDebe = 0;
                        let totalHaber = 0;

                        asiento.asientos.forEach(asi => {
                            totalDebe += asi.debe || 0;
                            totalHaber += asi.haber || 0;
                            
                            // Buscar nombre de cuenta si no est√° incluido
                            const cuentaInfo = planCuentasCompleto.find(c => c.codigo === asi.cuenta) || { nombre: asi.nombre || 'Cuenta no encontrada' };
                            
                            asientosHtml += `
                                <div class="entry-row" style="${asi.cuenta.split('.').length > 4 ? 'padding-left: 20px;' : ''}">
                                    <div>
                                        <span style="font-family: monospace; font-weight: ${asi.cuenta.split('.').length <= 4 ? 'bold' : 'normal'};">${asi.cuenta}</span>
                                        <span style="margin-left: 8px;">${cuentaInfo.nombre}</span>
                                    </div>
                                    <div class="entry-debit">${asi.debe > 0 ? utils.formatMoney(asi.debe) : ''}</div>
                                    <div class="entry-credit">${asi.haber > 0 ? utils.formatMoney(asi.haber) : ''}</div>
                                </div>
                            `;
                        });

                        const html = `
                            <div class="accounting-entry">
                                <div class="entry-header">
                                    <span>${utils.formatDate(asiento.fecha)} | ${asiento.tipo} | Ref: ${asiento.referencia?.substr(-6) || '-'}</span>
                                    <span style="font-size: 11px;">${asiento.descripcion || ''}</span>
                                </div>
                                ${asientosHtml}
                                <div class="entry-row" style="border-top: 1px solid var(--gray-border); margin-top: 8px; padding-top: 8px; font-weight: bold;">
                                    <div>TOTAL</div>
                                    <div class="entry-debit">${utils.formatMoney(totalDebe)}</div>
                                    <div class="entry-credit">${utils.formatMoney(totalHaber)}</div>
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; text-align: right;">
                                    Registrado por: ${asiento.createdByName || 'Sistema'} | ${utils.formatDateTime(asiento.createdAt)}
                                </div>
                            </div>
                        `;
                        container.innerHTML += html;
                    });
                });
            },

            loadMayor: () => {
                const cuenta = document.getElementById('mayorAccountSelect')?.value;
                const container = document.getElementById('mayorContainer');
                
                if (!cuenta) {
                    // Mostrar resumen de todas las cuentas con movimiento
                    database.ref('contabilidad/diario').once('value', (snapshot) => {
                        const movimientosPorCuenta = {};
                        
                        snapshot.forEach((child) => {
                            const asiento = child.val();
                            asiento.asientos.forEach((asi) => {
                                if (!movimientosPorCuenta[asi.cuenta]) {
                                    movimientosPorCuenta[asi.cuenta] = { debe: 0, haber: 0, movimientos: 0 };
                                }
                                movimientosPorCuenta[asi.cuenta].debe += asi.debe || 0;
                                movimientosPorCuenta[asi.cuenta].haber += asi.haber || 0;
                                movimientosPorCuenta[asi.cuenta].movimientos++;
                            });
                        });

                        let html = `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descripci√≥n</th>
                                        <th class="text-right">Total D√©bito</th>
                                        <th class="text-right">Total Cr√©dito</th>
                                        <th class="text-right">Saldo</th>
                                        <th class="text-right">Movs.</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        Object.entries(movimientosPorCuenta)
                            .sort((a, b) => a[0].localeCompare(b[0]))
                            .forEach(([codigo, datos]) => {
                                const cuentaInfo = planCuentasCompleto.find(c => c.codigo === codigo) || { nombre: 'Cuenta desconocida', naturaleza: 'DEUDOR' };
                                let saldo = 0;
                                
                                if (cuentaInfo.naturaleza === 'DEUDOR') {
                                    saldo = datos.debe - datos.haber;
                                } else {
                                    saldo = datos.haber - datos.debe;
                                }

                                // Actualizar saldo en la tabla de plan de cuentas
                                const saldoCell = document.getElementById(`saldo-${codigo.replace(/\./g, '-')}`);
                                if (saldoCell) {
                                    saldoCell.textContent = utils.formatMoney(saldo);
                                    saldoCell.style.color = saldo < 0 ? 'var(--danger)' : (saldo > 0 ? 'var(--success)' : 'inherit');
                                    saldoCell.style.fontWeight = saldo !== 0 ? 'bold' : 'normal';
                                }

                                html += `
                                    <tr>
                                        <td style="font-family: monospace;">${codigo}</td>
                                        <td>${cuentaInfo.nombre}</td>
                                        <td class="text-right">${utils.formatMoney(datos.debe)}</td>
                                        <td class="text-right">${utils.formatMoney(datos.haber)}</td>
                                        <td class="text-right" style="font-weight: bold; color: ${saldo < 0 ? 'var(--danger)' : (saldo > 0 ? 'var(--success)' : 'inherit')}">${utils.formatMoney(saldo)}</td>
                                        <td class="text-center">${datos.movimientos}</td>
                                    </tr>
                                `;
                            });

                        html += '</tbody></table>';
                        container.innerHTML = html;
                    });
                    return;
                }

                // Mostrar detalle de cuenta espec√≠fica
                database.ref('contabilidad/diario').once('value', (snapshot) => {
                    let movimientos = [];
                    let saldoAcumulado = 0;
                    
                    const cuentaInfo = planCuentasCompleto.find(c => c.codigo === cuenta) || { nombre: 'Cuenta desconocida', naturaleza: 'DEUDOR' };

                    snapshot.forEach((child) => {
                        const asiento = child.val();
                        asiento.asientos.forEach((asi) => {
                            if (asi.cuenta === cuenta) {
                                movimientos.push({
                                    fecha: asiento.fecha,
                                    descripcion: asiento.descripcion,
                                    tipo: asiento.tipo,
                                    referencia: asiento.referencia,
                                    debe: asi.debe || 0,
                                    haber: asi.haber || 0
                                });
                            }
                        });
                    });

                    if (movimientos.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">No hay movimientos para esta cuenta</div>';
                        return;
                    }

                    // Ordenar por fecha
                    movimientos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

                    let html = `
                        <h4 style="margin-bottom: 16px; color: var(--primary-blue);">
                            ${cuenta} - ${cuentaInfo.nombre}
                            <span style="font-size: 12px; color: var(--text-secondary); margin-left: 12px;">(${cuentaInfo.naturaleza})</span>
                        </h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripci√≥n</th>
                                    <th>Ref.</th>
                                    <th class="text-right">D√©bito</th>
                                    <th class="text-right">Cr√©dito</th>
                                    <th class="text-right">Saldo</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    movimientos.forEach(mov => {
                        if (cuentaInfo.naturaleza === 'DEUDOR') {
                            saldoAcumulado += mov.debe - mov.haber;
                        } else {
                            saldoAcumulado += mov.haber - mov.debe;
                        }

                        html += `
                            <tr>
                                <td>${utils.formatDate(mov.fecha)}</td>
                                <td>${mov.descripcion}<br><small style="color: var(--text-secondary);">${mov.tipo}</small></td>
                                <td style="font-family: monospace;">${mov.referencia?.substr(-6) || '-'}</td>
                                <td class="text-right" style="color: var(--danger);">${mov.debe > 0 ? utils.formatMoney(mov.debe) : ''}</td>
                                <td class="text-right" style="color: var(--success);">${mov.haber > 0 ? utils.formatMoney(mov.haber) : ''}</td>
                                <td class="text-right" style="font-weight: bold;">${utils.formatMoney(saldoAcumulado)}</td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                            <tfoot style="font-weight: bold; background: var(--gray-bg);">
                                <tr>
                                    <td colspan="3">SALDO FINAL</td>
                                    <td colspan="3" class="text-right" style="font-size: 16px; color: ${saldoAcumulado < 0 ? 'var(--danger)' : 'var(--primary-blue)'};">
                                        ${utils.formatMoney(saldoAcumulado)}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    `;
                    container.innerHTML = html;
                });
            },

            generateBalance: () => {
                const container = document.getElementById('balanceContainer');
                const dateTo = document.getElementById('accountingDateTo')?.value || utils.getToday();
                
                database.ref('contabilidad/diario').once('value', (snapshot) => {
                    const totales = {};
                    
                    snapshot.forEach((child) => {
                        const asiento = child.val();
                        // Filtrar por fecha si es necesario
                        if (dateTo && asiento.fecha > dateTo) return;
                        
                        asiento.asientos.forEach(asi => {
                            if (!totales[asi.cuenta]) {
                                totales[asi.cuenta] = { debe: 0, haber: 0 };
                            }
                            totales[asi.cuenta].debe += asi.debe || 0;
                            totales[asi.cuenta].haber += asi.haber || 0;
                        });
                    });

                    // Calcular totales por grupo
                    const calcularGrupo = (prefijo) => {
                        let total = 0;
                        Object.entries(totales).forEach(([codigo, datos]) => {
                            if (codigo.startsWith(prefijo)) {
                                const cuentaInfo = planCuentasCompleto.find(c => c.codigo === codigo) || { naturaleza: 'DEUDOR' };
                                if (cuentaInfo.naturaleza === 'DEUDOR') {
                                    total += datos.debe - datos.haber;
                                } else {
                                    total += datos.haber - datos.debe;
                                }
                            }
                        });
                        return total;
                    };

                    const activos = calcularGrupo('1');
                    const pasivos = calcularGrupo('2');
                    const patrimonioCuentas = calcularGrupo('3');
                    
                    // Calcular resultado del ejercicio
                    const ingresos = calcularGrupo('4');
                    const gastos = calcularGrupo('5');
                    const utilidadEjercicio = ingresos - gastos;
                    
                    const patrimonioTotal = patrimonioCuentas + utilidadEjercicio;

                    let html = `
                        <div class="report-container">
                            <div class="report-header">
                                <div class="report-title">Balance General</div>
                                <div class="report-subtitle">Al ${utils.formatDate(dateTo)}</div>
                            </div>
                            
                            <div class="report-section">
                                <h4 style="color: var(--primary-blue); margin-bottom: 12px; border-bottom: 2px solid var(--primary-blue); padding-bottom: 8px;">ACTIVOS</h4>
                                ${accountingModule.generarDetalleGrupo(totales, '1')}
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--gray-bg); font-weight: bold; font-size: 14px; margin-top: 8px;">
                                    <span>TOTAL ACTIVOS</span>
                                    <span>${utils.formatMoney(activos)}</span>
                                </div>
                            </div>

                            <div class="report-section">
                                <h4 style="color: var(--primary-blue); margin-bottom: 12px; border-bottom: 2px solid var(--primary-blue); padding-bottom: 8px;">PASIVOS</h4>
                                ${accountingModule.generarDetalleGrupo(totales, '2')}
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--gray-bg); font-weight: bold; font-size: 14px; margin-top: 8px;">
                                    <span>TOTAL PASIVOS</span>
                                    <span>${utils.formatMoney(pasivos)}</span>
                                </div>
                            </div>

                            <div class="report-section">
                                <h4 style="color: var(--primary-blue); margin-bottom: 12px; border-bottom: 2px solid var(--primary-blue); padding-bottom: 8px;">PATRIMONIO</h4>
                                ${accountingModule.generarDetalleGrupo(totales, '3')}
                                <div style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px dashed var(--gray-border);">
                                    <span>Utilidad del Ejercicio</span>
                                    <span style="color: ${utilidadEjercicio >= 0 ? 'var(--success)' : 'var(--danger)'};">${utils.formatMoney(utilidadEjercicio)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--gray-bg); font-weight: bold; font-size: 14px; margin-top: 8px;">
                                    <span>TOTAL PATRIMONIO</span>
                                    <span>${utils.formatMoney(patrimonioTotal)}</span>
                                </div>
                            </div>

                            <div class="report-section" style="margin-top: 24px; padding-top: 16px; border-top: 3px solid var(--primary-blue);">
                                <div style="display: flex; justify-content: space-between; padding: 16px; background: ${Math.abs(activos - (pasivos + patrimonioTotal)) < 0.01 ? '#f0fdf4' : '#fef2f2'}; border-radius: 4px;">
                                    <span style="font-weight: bold; font-size: 16px;">PASIVO + PATRIMONIO</span>
                                    <span style="font-weight: bold; font-size: 16px;">${utils.formatMoney(pasivos + patrimonioTotal)}</span>
                                </div>
                                <div style="text-align: center; margin-top: 12px; color: ${Math.abs(activos - (pasivos + patrimonioTotal)) < 0.01 ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">
                                    ${Math.abs(activos - (pasivos + patrimonioTotal)) < 0.01 ? '‚úì BALANCE CUADRADO' : '‚úó DIFERENCIA: ' + utils.formatMoney(activos - (pasivos + patrimonioTotal))}
                                </div>
                            </div>
                        </div>
                    `;

                    container.innerHTML = html;
                });
            },

            generarDetalleGrupo: (totales, prefijo) => {
                let html = '<table style="width: 100%; font-size: 12px;">';
                
                // Agrupar por subniveles
                const cuentasFiltradas = Object.entries(totales)
                    .filter(([codigo]) => codigo.startsWith(prefijo))
                    .sort((a, b) => a[0].localeCompare(b[0]));

                cuentasFiltradas.forEach(([codigo, datos]) => {
                    const cuentaInfo = planCuentasCompleto.find(c => c.codigo === codigo);
                    if (!cuentaInfo || cuentaInfo.nivel > 4) return; // Solo mostrar hasta nivel 4 en resumen

                    let saldo = 0;
                    if (cuentaInfo.naturaleza === 'DEUDOR') {
                        saldo = datos.debe - datos.haber;
                    } else {
                        saldo = datos.haber - datos.debe;
                    }

                    if (Math.abs(saldo) < 0.01) return; // Omitir saldos cero

                    const padding = (cuentaInfo.nivel - 1) * 20;
                    const esTitulo = cuentaInfo.nivel <= 2;
                    
                    html += `
                        <tr style="${esTitulo ? 'font-weight: bold; background: #f8fafc;' : ''}; border-bottom: 1px solid #f1f5f9;">
                            <td style="padding-left: ${padding}px; padding-top: 6px; padding-bottom: 6px;">
                                ${codigo} - ${cuentaInfo.nombre}
                            </td>
                            <td class="text-right" style="font-weight: ${esTitulo ? 'bold' : 'normal'};">
                                ${utils.formatMoney(saldo)}
                            </td>
                        </tr>
                    `;
                });

                html += '</table>';
                return html;
            },

            generateResultados: () => {
                const container = document.getElementById('resultadosContainer');
                const dateFrom = document.getElementById('accountingDateFrom')?.value;
                const dateTo = document.getElementById('accountingDateTo')?.value || utils.getToday();

                database.ref('contabilidad/diario').once('value', (snapshot) => {
                    let ingresos = 0;
                    let gastos = 0;
                    const detalleIngresos = {};
                    const detalleGastos = {};

                    snapshot.forEach((child) => {
                        const asiento = child.val();
                        // Filtrar por rango de fechas
                        if (dateFrom && asiento.fecha < dateFrom) return;
                        if (dateTo && asiento.fecha > dateTo) return;

                        asiento.asientos.forEach(asi => {
                            const cuentaInfo = planCuentasCompleto.find(c => c.codigo === asi.cuenta);
                            if (!cuentaInfo) return;

                            if (asi.cuenta.startsWith('4')) {
                                const monto = (asi.haber || 0) - (asi.debe || 0);
                                ingresos += monto;
                                if (!detalleIngresos[asi.cuenta]) detalleIngresos[asi.cuenta] = { nombre: cuentaInfo.nombre, monto: 0 };
                                detalleIngresos[asi.cuenta].monto += monto;
                            } else if (asi.cuenta.startsWith('5')) {
                                const monto = (asi.debe || 0) - (asi.haber || 0);
                                gastos += monto;
                                if (!detalleGastos[asi.cuenta]) detalleGastos[asi.cuenta] = { nombre: cuentaInfo.nombre, monto: 0 };
                                detalleGastos[asi.cuenta].monto += monto;
                            }
                        });
                    });

                    const utilidad = ingresos - gastos;

                    let html = `
                        <div class="report-container">
                            <div class="report-header">
                                <div class="report-title">Estado de Resultados</div>
                                <div class="report-subtitle">
                                    ${dateFrom ? `Del ${utils.formatDate(dateFrom)} al ${utils.formatDate(dateTo)}` : `Al ${utils.formatDate(dateTo)}`}
                                </div>
                            </div>
                            
                            <div class="report-section">
                                <h4 style="color: var(--success); margin-bottom: 12px; border-bottom: 2px solid var(--success); padding-bottom: 8px;">INGRESOS</h4>
                                <table style="width: 100%; font-size: 12px; margin-bottom: 12px;">
                    `;

                    Object.entries(detalleIngresos).forEach(([codigo, datos]) => {
                        html += `
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 6px 0;">${codigo} - ${datos.nombre}</td>
                                <td class="text-right">${utils.formatMoney(datos.monto)}</td>
                            </tr>
                        `;
                    });

                    html += `
                                </table>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f0fdf4; font-weight: bold; font-size: 14px;">
                                    <span>TOTAL INGRESOS</span>
                                    <span>${utils.formatMoney(ingresos)}</span>
                                </div>
                            </div>

                            <div class="report-section">
                                <h4 style="color: var(--danger); margin-bottom: 12px; border-bottom: 2px solid var(--danger); padding-bottom: 8px;">GASTOS</h4>
                                <table style="width: 100%; font-size: 12px; margin-bottom: 12px;">
                    `;

                    Object.entries(detalleGastos).forEach(([codigo, datos]) => {
                        html += `
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 6px 0;">${codigo} - ${datos.nombre}</td>
                                <td class="text-right">${utils.formatMoney(datos.monto)}</td>
                            </tr>
                        `;
                    });

                    html += `
                                </table>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #fef2f2; font-weight: bold; font-size: 14px;">
                                    <span>TOTAL GASTOS</span>
                                    <span>${utils.formatMoney(gastos)}</span>
                                </div>
                            </div>

                            <div class="report-section" style="margin-top: 24px; padding: 20px; background: ${utilidad >= 0 ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px; border: 2px solid ${utilidad >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; font-size: 18px; color: ${utilidad >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${utilidad >= 0 ? 'UTILIDAD NETA DEL EJERCICIO' : 'P√âRDIDA DEL EJERCICIO'}
                                    </span>
                                    <span style="font-weight: bold; font-size: 24px; color: ${utilidad >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${utils.formatMoney(Math.abs(utilidad))}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;

                    container.innerHTML = html;
                });
            },

            refresh: () => {
                accountingModule.loadCurrentTab();
            },

            exportToExcel: () => {
                // Exportar seg√∫n tab activo
                if (accountingModule.currentTab === 'diario') {
                    database.ref('contabilidad/diario').once('value', (snapshot) => {
                        const data = [];
                        snapshot.forEach((child) => {
                            const asiento = child.val();
                            asiento.asientos.forEach((asi, idx) => {
                                data.push({
                                    Asiento_ID: child.key,
                                    Fecha: asiento.fecha,
                                    Tipo: asiento.tipo,
                                    Descripcion: asiento.descripcion,
                                    Referencia: asiento.referencia,
                                    Cuenta: asi.cuenta,
                                    Nombre_Cuenta: asi.nombre,
                                    Debe: asi.debe,
                                    Haber: asi.haber
                                });
                            });
                        });
                        utils.exportToExcel(data, 'Libro_Diario_' + utils.getToday(), 'Diario');
                    });
                } else if (accountingModule.currentTab === 'mayor') {
                    const cuenta = document.getElementById('mayorAccountSelect')?.value || 'Todas';
                    database.ref('contabilidad/diario').once('value', (snapshot) => {
                        const movimientos = [];
                        snapshot.forEach((child) => {
                            const asiento = child.val();
                            asiento.asientos.forEach((asi) => {
                                if (!cuenta || asi.cuenta === cuenta || cuenta === 'Todas') {
                                    movimientos.push({
                                        Fecha: asiento.fecha,
                                        Tipo: asiento.tipo,
                                        Descripcion: asiento.descripcion,
                                        Cuenta: asi.cuenta,
                                        Debe: asi.debe,
                                        Haber: asi.haber
                                    });
                                }
                            });
                        });
                        utils.exportToExcel(movimientos, 'Libro_Mayor_' + utils.getToday(), 'Mayor');
                    });
                }
            }
        };

        // ==========================================
        // M√ìDULO REPORTES (COMPLETO)
        // ==========================================
        const reportModule = {
            currentReport: null,
            reportData: null,

            init: () => {
                // Cargar clientes para filtro
                database.ref('clientes').once('value', (snapshot) => {
                    const select = document.getElementById('reportClientSelect');
                    select.innerHTML = '<option value="">Seleccione cliente...</option>';
                    
                    snapshot.forEach((child) => {
                        const client = child.val();
                        select.innerHTML += `<option value="${child.key}">${client.apellidos}, ${client.nombres}</option>`;
                    });
                });

                // Set fechas por defecto
                const hoy = utils.getToday();
                const inicioMes = hoy.substring(0, 8) + '01';
                document.getElementById('reportDateFrom').value = inicioMes;
                document.getElementById('reportDateTo').value = hoy;
            },

            updateForm: () => {
                const tipo = document.getElementById('reportType').value;
                const filters = document.getElementById('reportFilters');
                const clientFilter = document.getElementById('reportClientFilter');
                const dateRange = document.getElementById('reportDateRange');

                filters.style.display = 'block';
                
                if (tipo === 'estado_cuenta') {
                    clientFilter.style.display = 'block';
                    dateRange.style.display = 'none';
                } else {
                    clientFilter.style.display = 'none';
                    dateRange.style.display = 'grid';
                }
            },

            generate: () => {
                const tipo = document.getElementById('reportType').value;
                const dateFrom = document.getElementById('reportDateFrom').value;
                const dateTo = document.getElementById('reportDateTo').value;
                const clientId = document.getElementById('reportClientSelect').value;

                if (!tipo) {
                    utils.showToast('Seleccione un tipo de reporte', 'error');
                    return;
                }

                utils.showLoading(true);
                document.getElementById('reportContainer').style.display = 'none';

                switch(tipo) {
                    case 'cartera':
                        reportModule.generateCartera(dateFrom, dateTo);
                        break;
                    case 'cartera_vencida':
                        reportModule.generateCarteraVencida();
                        break;
                    case 'ingresos':
                        reportModule.generateIngresos(dateFrom, dateTo);
                        break;
                    case 'estado_cuenta':
                        reportModule.generateEstadoCuenta(clientId);
                        break;
                    case 'flujo_caja':
                        reportModule.generateFlujoCaja(dateFrom, dateTo);
                        break;
                    case 'morosidad':
                        reportModule.generateMorosidad();
                        break;
                }
            },

            generateCartera: (dateFrom, dateTo) => {
                Promise.all([
                    database.ref('creditos').once('value'),
                    database.ref('clientes').once('value')
                ]).then(([creditsSnap, clientsSnap]) => {
                    const credits = creditsSnap.val() || {};
                    const clients = clientsSnap.val() || {};
                    
                    let totalCapital = 0;
                    let totalInteres = 0;
                    let totalSaldo = 0;
                    let html = '';

                    Object.entries(credits).forEach(([id, credit]) => {
                        if (credit.estado !== 'ACTIVO') return;
                        
                        // Filtro de fecha
                        if (dateFrom && credit.fechaDesembolso < dateFrom) return;
                        if (dateTo && credit.fechaDesembolso > dateTo) return;
                        
                        const client = clients[credit.clienteId];
                        totalCapital += credit.monto;
                        totalInteres += credit.interesPendiente || 0;
                        totalSaldo += credit.saldoActual;

                        html += `
                            <tr>
                                <td>${id.substr(-6)}</td>
                                <td>${client ? client.apellidos + ', ' + client.nombres : 'N/A'}</td>
                                <td>${client?.numeroDocumento || '-'}</td>
                                <td>${utils.formatDate(credit.fechaDesembolso)}</td>
                                <td class="text-right">${utils.formatMoney(credit.monto)}</td>
                                <td class="text-right">${utils.formatMoney(credit.saldoActual)}</td>
                                <td class="text-right">${utils.formatMoney(credit.interesPendiente || 0)}</td>
                                <td class="text-right">${credit.plazo}</td>
                                <td class="text-right">${credit.pagosRealizados}</td>
                                <td>${utils.formatDate(credit.proximoPago)}</td>
                                <td style="color: ${credit.diasMora > 0 ? 'var(--danger)' : 'inherit'}; font-weight: ${credit.diasMora > 0 ? 'bold' : 'normal'};">
                                    ${credit.diasMora || 0}
                                </td>
                            </tr>
                        `;
                    });

                    reportModule.currentReport = {
                        titulo: 'Cartera Activa Detallada',
                        subtitulo: `Per√≠odo: ${utils.formatDate(dateFrom)} al ${utils.formatDate(dateTo)}`,
                        contenido: `
                            <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary);">Capital Desembolsado</div>
                                    <div style="font-size: 18px; font-weight: bold; color: var(--primary-blue);">${utils.formatMoney(totalCapital)}</div>
                                </div>
                                <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary);">Saldo Pendiente</div>
                                    <div style="font-size: 18px; font-weight: bold; color: var(--success);">${utils.formatMoney(totalSaldo)}</div>
                                </div>
                                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary);">Intereses por Cobrar</div>
                                    <div style="font-size: 18px; font-weight: bold; color: var(--warning);">${utils.formatMoney(totalInteres)}</div>
                                </div>
                            </div>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>No. Cr√©dito</th>
                                        <th>Cliente</th>
                                        <th>Documento</th>
                                        <th>Fecha Desembolso</th>
                                        <th class="text-right">Monto Original</th>
                                        <th class="text-right">Saldo Capital</th>
                                        <th class="text-right">Inter√©s Pendiente</th>
                                        <th class="text-right">Plazo</th>
                                        <th class="text-right">Cuotas Pag.</th>
                                        <th>Pr√≥ximo Pago</th>
                                        <th>Mora</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${html || '<tr><td colspan="11" class="text-center">No hay cr√©ditos activos en el per√≠odo</td></tr>'}
                                </tbody>
                                <tfoot style="font-weight: bold; background: var(--gray-bg);">
                                    <tr>
                                        <td colspan="4">TOTALES</td>
                                        <td class="text-right">${utils.formatMoney(totalCapital)}</td>
                                        <td class="text-right">${utils.formatMoney(totalSaldo)}</td>
                                        <td class="text-right">${utils.formatMoney(totalInteres)}</td>
                                        <td colspan="4"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        `
                    };

                    reportModule.displayReport();
                    utils.showLoading(false);
                });
            },

            generateCarteraVencida: () => {
                Promise.all([
                    database.ref('creditos').orderByChild('diasMora').startAt(1).once('value'),
                    database.ref('clientes').once('value')
                ]).then(([creditsSnap, clientsSnap]) => {
                    const credits = creditsSnap.val() || {};
                    const clients = clientsSnap.val() || {};
                    
                    let totalVencido = 0;
                    let totalMora = 0;
                    let html = '';

                    // Agrupar por rangos de mora
                    const rangos = {
                        '1-30': [],
                        '31-60': [],
                        '61-90': [],
                        '90+': []
                    };

                    Object.entries(credits).forEach(([id, credit]) => {
                        const client = clients[credit.clienteId];
                        const dias = credit.diasMora || 0;
                        
                        totalVencido += credit.saldoActual;
                        
                        const rowData = {
                            id: id.substr(-6),
                            cliente: client ? `${client.apellidos}, ${client.nombres}` : 'N/A',
                            documento: client?.numeroDocumento || '-',
                            telefono: client?.telefono || 'N/A',
                            saldo: credit.saldoActual,
                            dias: dias,
                            proximoPago: credit.proximoPago,
                            cuotasPagadas: credit.pagosRealizados,
                            cuotaMensual: credit.cuotaMensual
                        };

                        if (dias <= 30) rangos['1-30'].push(rowData);
                        else if (dias <= 60) rangos['31-60'].push(rowData);
                        else if (dias <= 90) rangos['61-90'].push(rowData);
                        else rangos['90+'].push(rowData);
                    });

                    // Generar HTML por rangos
                    Object.entries(rangos).forEach(([rango, creditos]) => {
                        if (creditos.length === 0) return;
                        
                        const subtotal = creditos.reduce((sum, c) => sum + c.saldo, 0);
                        
                        html += `
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: ${rango === '90+' ? 'var(--danger)' : (rango === '61-90' ? 'var(--warning)' : 'var(--primary-blue)')}; 
                                           border-bottom: 2px solid ${rango === '90+' ? 'var(--danger)' : (rango === '61-90' ? 'var(--warning)' : 'var(--primary-blue)')}; 
                                           padding-bottom: 8px; margin-bottom: 12px;">
                                    Mora ${rango} d√≠as (${creditos.length} cr√©ditos) - ${utils.formatMoney(subtotal)}
                                </h4>
                                <table class="report-table" style="margin-bottom: 16px;">
                                    <thead>
                                        <tr>
                                            <th>No.</th>
                                            <th>Cliente</th>
                                            <th>Documento</th>
                                            <th>Tel√©fono</th>
                                            <th class="text-right">Saldo</th>
                                            <th class="text-right">Cuota</th>
                                            <th class="text-right">D√≠as Mora</th>
                                            <th>Vencimiento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${creditos.map(c => `
                                            <tr>
                                                <td>${c.id}</td>
                                                <td>${c.cliente}</td>
                                                <td>${c.documento}</td>
                                                <td>${c.telefono}</td>
                                                <td class="text-right">${utils.formatMoney(c.saldo)}</td>
                                                <td class="text-right">${utils.formatMoney(c.cuotaMensual)}</td>
                                                <td class="text-right" style="color: ${c.dias > 60 ? 'var(--danger)' : 'var(--warning)'}; font-weight: bold;">${c.dias}</td>
                                                <td>${utils.formatDate(c.proximoPago)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });

                    reportModule.currentReport = {
                        titulo: 'Cartera Vencida - An√°lisis de Morosidad',
                        subtitulo: `Al ${utils.formatDate(utils.getToday())} | Total Cartera en Mora: ${utils.formatMoney(totalVencido)}`,
                        contenido: html || '<div class="alert alert-success">No hay cr√©ditos en mora actualmente</div>'
                    };

                    reportModule.displayReport();
                    utils.showLoading(false);
                });
            },

            generateIngresos: (dateFrom, dateTo) => {
                database.ref('pagos').orderByChild('fecha').startAt(dateFrom).endAt(dateTo).once('value', (snapshot) => {
                    let totalCapital = 0;
                    let totalInteres = 0;
                    let totalMora = 0;
                    let totalComisiones = 0;
                    let html = '';

                    const pagosPorMes = {};

                    snapshot.forEach((child) => {
                        const pago = child.val();
                        if (pago.estado === 'ANULADO') return;

                        totalCapital += pago.capital || 0;
                        totalInteres += pago.interes || 0;
                        totalMora += pago.mora || 0;

                        // Agrupar por mes
                        const mes = pago.fecha.substring(0, 7); // YYYY-MM
                        if (!pagosPorMes[mes]) {
                            pagosPorMes[mes] = { capital: 0, interes: 0, mora: 0, count: 0 };
                        }
                        pagosPorMes[mes].capital += pago.capital || 0;
                        pagosPorMes[mes].interes += pago.interes || 0;
                        pagosPorMes[mes].mora += pago.mora || 0;
                        pagosPorMes[mes].count++;

                        html += `
                            <tr>
                                <td>${utils.formatDate(pago.fecha)}</td>
                                <td>${pago.creditoId?.substr(-6)}</td>
                                <td>${pago.clienteNombre}</td>
                                <td><span class="badge badge-${pago.tipo === 'CUOTA' ? 'info' : (pago.tipo === 'TOTAL' ? 'success' : 'warning')}">${pago.tipo}</span></td>
                                <td class="text-right">${utils.formatMoney(pago.capital || 0)}</td>
                                <td class="text-right">${utils.formatMoney(pago.interes || 0)}</td>
                                <td class="text-right">${utils.formatMoney(pago.mora || 0)}</td>
                                <td class="text-right" style="font-weight: bold;">${utils.formatMoney(pago.monto)}</td>
                                <td>${pago.metodo}</td>
                            </tr>
                        `;
                    });

                    const total = totalCapital + totalInteres + totalMora;

                    // Resumen por mes
                    let resumenMeses = '';
                    Object.entries(pagosPorMes).sort().forEach(([mes, datos]) => {
                        resumenMeses += `
                            <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f1f5f9;">
                                <span>${mes}</span>
                                <span>${datos.count} pagos | ${utils.formatMoney(datos.capital + datos.interes + datos.mora)}</span>
                            </div>
                        `;
                    });

                    reportModule.currentReport = {
                        titulo: 'Reporte de Ingresos y Recaudaci√≥n',
                        subtitulo: `Per√≠odo: ${utils.formatDate(dateFrom)} al ${utils.formatDate(dateTo)}`,
                        contenido: `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                                <div>
                                    <h4 style="margin-bottom: 12px;">Resumen por Mes</h4>
                                    <div style="background: #f8fafc; border-radius: 8px; padding: 12px;">
                                        ${resumenMeses || '<div class="text-muted">No hay datos</div>'}
                                    </div>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 12px;">Totales del Per√≠odo</h4>
                                    <div style="background: #f0f9ff; border-radius: 8px; padding: 16px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Capital Recuperado:</span>
                                            <span style="font-weight: bold;">${utils.formatMoney(totalCapital)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Intereses Ganados:</span>
                                            <span style="font-weight: bold; color: var(--success);">${utils.formatMoney(totalInteres)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Intereses por Mora:</span>
                                            <span style="font-weight: bold; color: var(--warning);">${utils.formatMoney(totalMora)}</span>
                                        </div>
                                        <div style="border-top: 2px solid var(--primary-blue); margin-top: 12px; padding-top: 12px; display: flex; justify-content: space-between; font-size: 16px; font-weight: bold;">
                                            <span>TOTAL RECAUDADO</span>
                                            <span style="color: var(--primary-blue);">${utils.formatMoney(total)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Cr√©dito</th>
                                        <th>Cliente</th>
                                        <th>Tipo</th>
                                        <th class="text-right">Capital</th>
                                        <th class="text-right">Inter√©s</th>
                                        <th class="text-right">Mora</th>
                                        <th class="text-right">Total</th>
                                        <th>M√©todo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${html || '<tr><td colspan="9" class="text-center">No hay pagos en el per√≠odo</td></tr>'}
                                </tbody>
                                <tfoot style="font-weight: bold; background: var(--gray-bg);">
                                    <tr>
                                        <td colspan="4">TOTALES</td>
                                        <td class="text-right">${utils.formatMoney(totalCapital)}</td>
                                        <td class="text-right">${utils.formatMoney(totalInteres)}</td>
                                        <td class="text-right">${utils.formatMoney(totalMora)}</td>
                                        <td class="text-right">${utils.formatMoney(total)}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        `
                    };

                    reportModule.displayReport();
                    utils.showLoading(false);
                });
            },

            generateEstadoCuenta: (clientId) => {
                if (!clientId) {
                    utils.showToast('Seleccione un cliente', 'error');
                    utils.showLoading(false);
                    return;
                }

                Promise.all([
                    database.ref('clientes/' + clientId).once('value'),
                    database.ref('creditos').orderByChild('clienteId').equalTo(clientId).once('value'),
                    database.ref('pagos').orderByChild('clienteId').equalTo(clientId).once('value')
                ]).then(([clientSnap, creditsSnap, paymentsSnap]) => {
                    const client = clientSnap.val();
                    if (!client) {
                        utils.showToast('Cliente no encontrado', 'error');
                        utils.showLoading(false);
                        return;
                    }

                    const credits = creditsSnap.val() || {};
                    const payments = paymentsSnap.val() || {};

                    // Calcular totales
                    let totalCreditos = 0;
                    let totalSaldo = 0;
                    let totalPagado = 0;

                    let creditsHtml = '';
                    Object.entries(credits).forEach(([id, credit]) => {
                        totalCreditos += credit.monto;
                        totalSaldo += credit.saldoActual || 0;
                        totalPagado += credit.totalPagado || 0;

                        const barraProgreso = credit.plazo > 0 ? (credit.pagosRealizados / credit.plazo) * 100 : 0;

                        creditsHtml += `
                            <tr>
                                <td>${id.substr(-6)}</td>
                                <td>${utils.formatDate(credit.fechaDesembolso)}</td>
                                <td class="text-right">${utils.formatMoney(credit.monto)}</td>
                                <td class="text-right">${utils.formatMoney(credit.saldoActual)}</td>
                                <td class="text-right">${utils.formatMoney(credit.cuotaMensual)}</td>
                                <td>
                                    <div style="background: #e2e8f0; border-radius: 4px; height: 20px; overflow: hidden;">
                                        <div style="background: ${credit.estado === 'CANCELADO' ? 'var(--success)' : 'var(--primary-blue)'}; 
                                                    width: ${barraProgreso}%; 
                                                    height: 100%; 
                                                    display: flex; 
                                                    align-items: center; 
                                                    justify-content: center; 
                                                    color: white; 
                                                    font-size: 10px;">
                                            ${Math.round(barraProgreso)}%
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge badge-${credit.estado === 'ACTIVO' ? 'success' : (credit.estado === 'CANCELADO' ? 'info' : 'danger')}">${credit.estado}</span></td>
                            </tr>
                        `;
                    });

                    // Ordenar pagos por fecha descendente
                    const sortedPayments = Object.entries(payments)
                        .filter(([_, p]) => p.estado !== 'ANULADO')
                        .sort((a, b) => new Date(b[1].fecha) - new Date(a[1].fecha));

                    let paymentsHtml = '';
                    sortedPayments.forEach(([id, pago]) => {
                        paymentsHtml += `
                            <tr>
                                <td>${utils.formatDate(pago.fecha)}</td>
                                <td>${pago.creditoId?.substr(-6)}</td>
                                <td>${pago.tipo}</td>
                                <td class="text-right">${utils.formatMoney(pago.capital || 0)}</td>
                                <td class="text-right">${utils.formatMoney(pago.interes || 0)}</td>
                                <td class="text-right" style="font-weight: bold;">${utils.formatMoney(pago.monto)}</td>
                                <td>${pago.metodo}</td>
                            </tr>
                        `;
                    });

                    reportModule.currentReport = {
                        titulo: 'Estado de Cuenta del Cliente',
                        subtitulo: `${client.apellidos}, ${client.nombres} | ${client.tipoDocumento}: ${client.numeroDocumento}`,
                        contenido: `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                                    <h4 style="margin-bottom: 16px; color: var(--primary-blue);">Informaci√≥n del Cliente</h4>
                                    <div style="font-size: 13px; line-height: 1.8;">
                                        <div><strong>Direcci√≥n:</strong> ${client.direccion || 'No registrada'}</div>
                                        <div><strong>Tel√©fono:</strong> ${client.telefono || 'No registrado'}</div>
                                        <div><strong>Email:</strong> ${client.email || 'No registrado'}</div>
                                        <div><strong>Profesi√≥n:</strong> ${client.profesion || 'No registrada'}</div>
                                        <div><strong>Empresa:</strong> ${client.empresa || 'No registrada'}</div>
                                    </div>
                                </div>
                                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px;">
                                    <h4 style="margin-bottom: 16px; color: var(--primary-blue);">Resumen Financiero</h4>
                                    <div style="font-size: 13px; line-height: 1.8;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Total Cr√©ditos:</span>
                                            <span style="font-weight: bold;">${utils.formatMoney(totalCreditos)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Total Pagado:</span>
                                            <span style="font-weight: bold; color: var(--success);">${utils.formatMoney(totalPagado)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; border-top: 2px solid var(--primary-blue); margin-top: 8px; padding-top: 8px;">
                                            <span>Saldo Pendiente:</span>
                                            <span style="font-weight: bold; color: ${totalSaldo > 0 ? 'var(--danger)' : 'var(--success)'}; font-size: 16px;">
                                                ${utils.formatMoney(totalSaldo)}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h4 style="margin-bottom: 12px; color: var(--primary-blue);">Historial de Cr√©ditos</h4>
                            <table class="report-table" style="margin-bottom: 24px;">
                                <thead>
                                    <tr>
                                        <th>No. Cr√©dito</th>
                                        <th>Fecha</th>
                                        <th class="text-right">Monto</th>
                                        <th class="text-right">Saldo</th>
                                        <th class="text-right">Cuota</th>
                                        <th>Progreso</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${creditsHtml || '<tr><td colspan="7" class="text-center">No hay cr√©ditos registrados</td></tr>'}
                                </tbody>
                            </table>

                            <h4 style="margin-bottom: 12px; color: var(--primary-blue);">Historial de Pagos</h4>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Cr√©dito</th>
                                        <th>Tipo</th>
                                        <th class="text-right">Capital</th>
                                        <th class="text-right">Inter√©s</th>
                                        <th class="text-right">Total</th>
                                        <th>M√©todo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paymentsHtml || '<tr><td colspan="7" class="text-center">No hay pagos registrados</td></tr>'}
                                </tbody>
                            </table>
                        `
                    };

                    reportModule.displayReport();
                    utils.showLoading(false);
                });
            },

            generateFlujoCaja: (dateFrom, dateTo) => {
                Promise.all([
                    database.ref('pagos').orderByChild('fecha').startAt(dateFrom).endAt(dateTo).once('value'),
                    database.ref('creditos').orderByChild('fechaDesembolso').startAt(dateFrom).endAt(dateTo).once('value')
                ]).then(([paymentsSnap, creditsSnap]) => {
                    const flujo = {};
                    
                    // Inicializar todos los d√≠as del per√≠odo
                    const start = new Date(dateFrom);
                    const end = new Date(dateTo);
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const fechaStr = d.toISOString().split('T')[0];
                        flujo[fechaStr] = { ingresos: 0, desembolsos: 0, comisiones: 0 };
                    }

                    // Procesar pagos (entradas)
                    paymentsSnap.forEach((child) => {
                        const pago = child.val();
                        if (pago.estado === 'ANULADO') return;
                        
                        if (flujo[pago.fecha]) {
                            flujo[pago.fecha].ingresos += pago.monto;
                        }
                    });

                    // Procesar desembolsos (salidas)
                    creditsSnap.forEach((child) => {
                        const credit = child.val();
                        if (flujo[credit.fechaDesembolso]) {
                            flujo[credit.fechaDesembolso].desembolsos += credit.monto;
                            flujo[credit.fechaDesembolso].comisiones += credit.comisionApertura || 0;
                        }
                    });

                    let html = '';
                    let totalIngresos = 0;
                    let totalDesembolsos = 0;
                    let totalComisiones = 0;
                    let saldoAcumulado = 0;

                    Object.entries(flujo).sort().forEach(([fecha, datos]) => {
                        const neto = datos.ingresos - datos.desembolsos;
                        saldoAcumulado += neto;
                        totalIngresos += datos.ingresos;
                        totalDesembolsos += datos.desembolsos;
                        totalComisiones += datos.comisiones;

                        if (datos.ingresos === 0 && datos.desembolsos === 0) return; // Omitir d√≠as sin movimiento

                        html += `
                            <tr>
                                <td>${utils.formatDate(fecha)}</td>
                                <td class="text-right" style="color: var(--success);">${datos.ingresos > 0 ? utils.formatMoney(datos.ingresos) : ''}</td>
                                <td class="text-right" style="color: var(--danger);">${datos.desembolsos > 0 ? utils.formatMoney(datos.desembolsos) : ''}</td>
                                <td class="text-right">${datos.comisiones > 0 ? utils.formatMoney(datos.comisiones) : ''}</td>
                                <td class="text-right" style="font-weight: bold; color: ${neto >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${neto !== 0 ? utils.formatMoney(neto) : ''}
                                </td>
                                <td class="text-right" style="font-weight: bold; color: ${saldoAcumulado >= 0 ? 'var(--primary-blue)' : 'var(--danger)'};">
                                    ${utils.formatMoney(saldoAcumulado)}
                                </td>
                            </tr>
                        `;
                    });

                    reportModule.currentReport = {
                        titulo: 'Flujo de Caja Detallado',
                        subtitulo: `Per√≠odo: ${utils.formatDate(dateFrom)} al ${utils.formatDate(dateTo)}`,
                        contenido: `
                            <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary);">Total Ingresos</div>
                                    <div style="font-size: 18px; font-weight: bold; color: var(--success);">${utils.formatMoney(totalIngresos)}</div>
                                </div>
                                <div style="background: #fef2f2; padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary);">Total Desembolsos</div>
                                    <div style="font-size: 18px; font-weight: bold; color: var(--danger);">${utils.formatMoney(totalDesembolsos)}</div>
                                </div>
                                <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary);">Comisiones</div>
                                    <div style="font-size: 18px; font-weight: bold; color: var(--primary-blue);">${utils.formatMoney(totalComisiones)}</div>
                                </div>
                                <div style="background: ${saldoAcumulado >= 0 ? '#f0fdf4' : '#fef2f2'}; padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary);">Saldo Final</div>
                                    <div style="font-size: 18px; font-weight: bold; color: ${saldoAcumulado >= 0 ? 'var(--success)' : 'var(--danger)'};">${utils.formatMoney(saldoAcumulado)}</div>
                                </div>
                            </div>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th class="text-right">Ingresos</th>
                                        <th class="text-right">Desembolsos</th>
                                        <th class="text-right">Comisiones</th>
                                        <th class="text-right">Neto</th>
                                        <th class="text-right">Saldo Acum.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${html || '<tr><td colspan="6" class="text-center">No hay movimientos en el per√≠odo</td></tr>'}
                                </tbody>
                            </table>
                        `
                    };

                    reportModule.displayReport();
                    utils.showLoading(false);
                });
            },

            generateMorosidad: () => {
                // Similar a cartera vencida pero con an√°lisis adicional
                reportModule.generateCarteraVencida();
            },

            displayReport: () => {
                const container = document.getElementById('reportContent');
                const previewSection = document.getElementById('reportPreviewSection');
                
                if (!reportModule.currentReport) return;

                container.innerHTML = `
                    <div class="report-container">
                        <div class="report-header">
                            <div class="report-title">${reportModule.currentReport.titulo}</div>
                            <div class="report-subtitle">${reportModule.currentReport.subtitulo}</div>
                        </div>
                        ${reportModule.currentReport.contenido}
                    </div>
                `;

                document.getElementById('reportContainer').style.display = 'block';
                previewSection.style.display = 'block';
            },

            exportPDF: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text(reportModule.currentReport.titulo, 10, 10);
                doc.text(reportModule.currentReport.subtitulo, 10, 20);
                
                // Aqu√≠ se implementar√≠a la l√≥gica completa de exportaci√≥n a PDF
                doc.save('reporte.pdf');
            },

            exportExcel: () => {
                // Implementar exportaci√≥n a Excel seg√∫n el tipo de reporte
                utils.showToast('Exportaci√≥n a Excel en desarrollo', 'info');
            },

            print: () => {
                window.print();
            }
        };

        // ==========================================
        // M√ìDULO CONFIGURACI√ìN
        // ==========================================
        const configModule = {
            init: () => {
                database.ref('configuracion').once('value', (snapshot) => {
                    const config = snapshot.val() || {};
                    document.getElementById('configTasaAnual').value = config.tasaAnual || 16;
                    document.getElementById('configTipoInteres').value = config.tipoInteres || 'simple';
                    document.getElementById('configCapitalizacion').value = config.capitalizacion || 'mensual';
                    document.getElementById('configMetodo').value = config.metodo || 'frances';
                    document.getElementById('configComision').value = config.comisionApertura || 0;
                    document.getElementById('configDiasGracia').value = config.diasGracia || 5;
                    document.getElementById('configTasaMora').value = config.tasaMora || 0.05;
                    document.getElementById('configPenalizacion').value = config.penalizacion || 0;
                    document.getElementById('configMontoMax').value = config.montoMax || 100000;
                    document.getElementById('configPlazoMin').value = config.plazoMin || 1;
                    document.getElementById('configPlazoMax').value = config.plazoMax || 360;
                });
            },

            save: () => {
                utils.showLoading(true);
                
                const config = {
                    tasaAnual: parseFloat(document.getElementById('configTasaAnual').value) || 16,
                    tipoInteres: document.getElementById('configTipoInteres').value,
                    capitalizacion: document.getElementById('configCapitalizacion').value,
                    metodo: document.getElementById('configMetodo').value,
                    comisionApertura: parseFloat(document.getElementById('configComision').value) || 0,
                    diasGracia: parseInt(document.getElementById('configDiasGracia').value) || 5,
                    tasaMora: parseFloat(document.getElementById('configTasaMora').value) || 0.05,
                    penalizacion: parseFloat(document.getElementById('configPenalizacion').value) || 0,
                    montoMax: parseFloat(document.getElementById('configMontoMax').value) || 100000,
                    plazoMin: parseInt(document.getElementById('configPlazoMin').value) || 1,
                    plazoMax: parseInt(document.getElementById('configPlazoMax').value) || 360,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: currentUser.uid
                };

                database.ref('configuracion').set(config)
                    .then(() => {
                        auditModule.log('update', 'configuracion', 'general', 'Actualizaci√≥n de configuraci√≥n del sistema');
                        utils.showLoading(false);
                        utils.showToast('Configuraci√≥n guardada exitosamente');
                    })
                    .catch((error) => {
                        utils.showLoading(false);
                        utils.showToast('Error: ' + error.message, 'error');
                    });
            }
        };

        // ==========================================
        // M√ìDULO AUDITOR√çA
        // ==========================================
        const auditModule = {
            logs: [],

            init: () => {
                auditModule.loadLogs();
                
                // Auto-refresh cada 30 segundos si est√° habilitado
                setInterval(() => {
                    if (document.getElementById('auditAutoRefresh')?.checked) {
                        auditModule.refresh();
                    }
                }, 30000);
            },

            loadLogs: () => {
                const dateFrom = document.getElementById('auditDateFrom')?.value;
                const dateTo = document.getElementById('auditDateTo')?.value;
                
                let query = database.ref('auditoria').limitToLast(200);
                
                query.once('value', (snapshot) => {
                    auditModule.logs = [];
                    snapshot.forEach((child) => {
                        const log = child.val();
                        // Filtros de fecha en memoria
                        if (dateFrom && log.timestamp) {
                            const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                            if (logDate < dateFrom) return;
                        }
                        if (dateTo && log.timestamp) {
                            const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                            if (logDate > dateTo) return;
                        }
                        auditModule.logs.push({ id: child.key, ...log });
                    });
                    
                    // Ordenar por fecha descendente
                    auditModule.logs.sort((a, b) => b.timestamp - a.timestamp);
                    auditModule.renderLogs();
                });
            },

            renderLogs: () => {
                const container = document.getElementById('auditContainer');
                const typeFilter = document.getElementById('auditTypeFilter')?.value;
                const entityFilter = document.getElementById('auditEntityFilter')?.value;
                const userFilter = document.getElementById('auditUserFilter')?.value.toLowerCase();

                let filtered = auditModule.logs;

                if (typeFilter) {
                    filtered = filtered.filter(l => l.tipo === typeFilter);
                }
                if (entityFilter) {
                    filtered = filtered.filter(l => l.entidad === entityFilter);
                }
                if (userFilter) {
                    filtered = filtered.filter(l => 
                        (l.usuarioNombre || '').toLowerCase().includes(userFilter) ||
                        (l.usuarioId || '').toLowerCase().includes(userFilter)
                    );
                }

                document.getElementById('auditCount').textContent = filtered.length;

                if (filtered.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No hay registros que coincidan con los filtros</div>';
                    return;
                }

                container.innerHTML = filtered.map(log => `
                    <div class="log-entry ${log.tipo}">
                        <div class="log-header">
                            <span>
                                <span class="badge badge-${log.tipo === 'create' ? 'success' : (log.tipo === 'update' ? 'warning' : (log.tipo === 'delete' ? 'danger' : (log.tipo === 'payment' ? 'info' : 'info')))}">
                                    ${log.tipo.toUpperCase()}
                                </span>
                                <strong style="margin-left: 8px;">${log.entidad.toUpperCase()}</strong>
                                <span style="color: var(--text-secondary); margin-left: 8px;">${log.entidadId?.substr(-6) || ''}</span>
                            </span>
                            <span style="font-size: 11px; color: var(--text-secondary);">
                                ${utils.formatDateTime(log.timestamp)}
                            </span>
                        </div>
                        <div style="margin-top: 4px;">${log.descripcion}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            Usuario: ${log.usuarioNombre || log.usuarioId || 'Sistema'}
                        </div>
                    </div>
                `).join('');
            },

            filter: () => {
                auditModule.renderLogs();
            },

            clearFilters: () => {
                document.getElementById('auditTypeFilter').value = '';
                document.getElementById('auditEntityFilter').value = '';
                document.getElementById('auditDateFrom').value = '';
                document.getElementById('auditDateTo').value = '';
                document.getElementById('auditUserFilter').value = '';
                auditModule.renderLogs();
            },

            refresh: () => {
                auditModule.loadLogs();
            },

            log: (tipo, entidad, entidadId, descripcion) => {
                const logData = {
                    tipo: tipo,
                    entidad: entidad,
                    entidadId: entidadId,
                    descripcion: descripcion,
                    usuarioId: currentUser?.uid || 'sistema',
                    usuarioNombre: currentUserData?.nombre || 'Sistema',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                database.ref('auditoria/' + utils.generateId()).set(logData);
            },

            confirmDeleteOld: () => {
                const hace6Meses = new Date();
                hace6Meses.setMonth(hace6Meses.getMonth() - 6);
                document.getElementById('archiveDate').value = hace6Meses.toISOString().split('T')[0];
                document.getElementById('modalArchiveAudit').classList.add('active');
            },

            closeArchiveModal: () => {
                document.getElementById('modalArchiveAudit').classList.remove('active');
            },

            executeArchive: () => {
                const fecha = document.getElementById('archiveDate').value;
                const confirmado = document.getElementById('archiveConfirm').checked;

                if (!fecha || !confirmado) {
                    utils.showToast('Seleccione fecha y confirme la acci√≥n', 'error');
                    return;
                }

                utils.showLoading(true);
                
                // Mover registros antiguos a archivo hist√≥rico
                database.ref('auditoria').orderByChild('timestamp').endAt(new Date(fecha).getTime()).once('value', (snapshot) => {
                    const updates = {};
                    snapshot.forEach((child) => {
                        updates['auditoria_archivo/' + child.key] = child.val();
                        updates['auditoria/' + child.key] = null;
                    });

                    database.ref().update(updates)
                        .then(() => {
                            auditModule.log('delete', 'auditoria', 'archivo', `Archivados registros anteriores a ${fecha}`);
                            utils.showLoading(false);
                            utils.showToast('Registros archivados exitosamente');
                            auditModule.closeArchiveModal();
                            auditModule.refresh();
                        })
                        .catch((error) => {
                            utils.showLoading(false);
                            utils.showToast('Error: ' + error.message, 'error');
                        });
                });
            },

            exportToExcel: () => {
                const data = auditModule.logs.map(l => ({
                    Fecha: utils.formatDateTime(l.timestamp),
                    Tipo: l.tipo,
                    Entidad: l.entidad,
                    ID_Entidad: l.entidadId,
                    Descripcion: l.descripcion,
                    Usuario: l.usuarioNombre || l.usuarioId
                }));
                utils.exportToExcel(data, 'Auditoria_' + utils.getToday(), 'Auditoria');
            }
        };

        // ==========================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar el m√≥dulo de autenticaci√≥n
            authModule.init();
        });
    </script>
</body>
</html>
